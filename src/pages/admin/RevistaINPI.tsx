import { useState, useEffect } from 'react';
import { AdminLayout } from '@/components/admin/AdminLayout';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Skeleton } from '@/components/ui/skeleton';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { supabase } from '@/integrations/supabase/client';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Upload, FileText, Users, Search, RefreshCw, CheckCircle, AlertCircle,
  Calendar, Loader2, BookOpen, Filter, Download, Eye, ArrowRight, Clock,
  Building2, Cloud, CloudDownload, Globe, Sparkles, Zap, UserPlus,
  AlertTriangle, BarChart3, TrendingUp, Shield, Activity, Newspaper,
  ExternalLink, Hash, Layers, Radio, Database, Wifi,
} from 'lucide-react';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';

// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
interface RpiUpload {
  id: string;
  file_name: string;
  file_path: string;
  rpi_date: string | null;
  rpi_number: string | null;
  total_processes_found: number;
  total_clients_matched: number;
  status: string;
  summary: string | null;
  processed_at: string | null;
  created_at: string;
}

interface RpiEntry {
  id: string;
  process_number: string;
  brand_name: string | null;
  ncl_classes: string[] | null;
  dispatch_type: string | null;
  dispatch_code: string | null;
  dispatch_text: string | null;
  publication_date: string | null;
  holder_name: string | null;
  matched_client_id: string | null;
  matched_process_id: string | null;
  update_status: string;
  tag: string | null;
  deadline_date?: string | null;
  priority?: 'urgent' | 'medium' | null;
  client?: { full_name: string | null; email: string; company_name: string | null };
  process?: { pipeline_stage: string | null; status: string | null };
}

interface Profile {
  id: string;
  full_name: string | null;
  email: string;
  company_name: string | null;
}

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAG_OPTIONS = [
  { value: 'pending', label: 'Aguardando', color: 'bg-muted text-muted-foreground' },
  { value: 'em_contato', label: 'Em contato', color: 'bg-blue-500/10 text-blue-600 dark:text-blue-400' },
  { value: 'resolvido', label: 'Resolvido', color: 'bg-emerald-500/10 text-emerald-600 dark:text-emerald-400' },
  { value: 'nao_responde', label: 'NÃ£o responde', color: 'bg-amber-500/10 text-amber-600 dark:text-amber-400' },
  { value: 'arquivado', label: 'Arquivado', color: 'bg-orange-500/10 text-orange-600 dark:text-orange-400' },
  { value: 'prazo_encerrado', label: 'Prazo encerrado', color: 'bg-red-500/10 text-red-600 dark:text-red-400' },
];

const PIPELINE_STAGES = [
  { value: 'protocolado', label: 'Protocolado' },
  { value: '003', label: '003 - ExigÃªncia' },
  { value: 'oposicao', label: 'OposiÃ§Ã£o' },
  { value: 'indeferimento', label: 'Indeferimento' },
  { value: 'notificacao_extrajudicial', label: 'NotificaÃ§Ã£o Extrajudicial' },
  { value: 'deferimento', label: 'Deferimento' },
  { value: 'certificados', label: 'Certificados' },
  { value: 'renovacao', label: 'RenovaÃ§Ã£o' },
  { value: 'distrato', label: 'Distrato' },
];

function getDispatchBadge(dispatchType: string | null) {
  const type = (dispatchType || '').toLowerCase();
  if (type.includes('deferido') || type.includes('deferimento'))
    return <Badge className="bg-emerald-500/10 text-emerald-600 border-emerald-500/20 dark:text-emerald-400">âœ“ Deferimento</Badge>;
  if (type.includes('indeferido') || type.includes('indeferimento'))
    return <Badge className="bg-red-500/10 text-red-600 border-red-500/20 dark:text-red-400">âœ— Indeferimento</Badge>;
  if (type.includes('exigÃªncia') || type.includes('exigencia'))
    return <Badge className="bg-amber-500/10 text-amber-600 border-amber-500/20 dark:text-amber-400">âš¡ ExigÃªncia</Badge>;
  if (type.includes('oposiÃ§Ã£o') || type.includes('oposicao'))
    return <Badge className="bg-orange-500/10 text-orange-600 border-orange-500/20 dark:text-orange-400">âš” OposiÃ§Ã£o</Badge>;
  if (type.includes('certificado'))
    return <Badge className="bg-blue-500/10 text-blue-600 border-blue-500/20 dark:text-blue-400">ğŸ“œ Certificado</Badge>;
  return <Badge variant="outline">{dispatchType || 'Outro'}</Badge>;
}

function suggestStage(dispatchCode: string | null, dispatchText: string | null): string {
  const text = (dispatchText || '').toLowerCase();
  if (text.includes('deferido') || text.includes('deferimento')) return 'deferimento';
  if (text.includes('indeferido') || text.includes('indeferimento')) return 'indeferimento';
  if (text.includes('exigÃªncia') || text.includes('exigencia')) return '003';
  if (text.includes('oposiÃ§Ã£o') || text.includes('oposicao')) return 'oposicao';
  if (text.includes('certificado') || text.includes('concessÃ£o')) return 'certificados';
  if (text.includes('renovaÃ§Ã£o') || text.includes('prorrogaÃ§Ã£o')) return 'renovacao';
  return 'protocolado';
}

// â”€â”€â”€ Animated stat card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function StatCard({ icon: Icon, label, value, gradient, delay = 0 }: { 
  icon: typeof FileText; label: string; value: string | number; gradient: string; delay?: number; 
}) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 24 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5, delay }}
    >
      <Card className={`relative overflow-hidden border-0 shadow-lg ${gradient}`}>
        <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent" />
        <CardContent className="relative pt-6 pb-5">
          <div className="flex items-center gap-4">
            <div className="p-3 rounded-xl bg-white/20 backdrop-blur-sm">
              <Icon className="h-6 w-6 text-white" />
            </div>
            <div>
              <p className="text-sm text-white/80 font-medium">{label}</p>
              <p className="text-2xl font-bold text-white tracking-tight">{value}</p>
            </div>
          </div>
        </CardContent>
      </Card>
    </motion.div>
  );
}

// â”€â”€â”€ Detail row for expanded cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DetailRow({ label, value, mono = false }: { label: string; value: string; mono?: boolean }) {
  return (
    <div className="flex items-center justify-between gap-2">
      <span className="text-[11px] text-muted-foreground whitespace-nowrap">{label}</span>
      <span className={`text-sm font-medium text-foreground truncate text-right ${mono ? 'font-mono text-xs' : ''}`}>
        {value}
      </span>
    </div>
  );
}

// â”€â”€â”€ Main Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default function RevistaINPI() {
  const [uploads, setUploads] = useState<RpiUpload[]>([]);
  const [entries, setEntries] = useState<RpiEntry[]>([]);
  const [selectedUpload, setSelectedUpload] = useState<RpiUpload | null>(null);
  const [loading, setLoading] = useState(true);
  const [uploading, setUploading] = useState(false);
  const [processing, setProcessing] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterMatched, setFilterMatched] = useState<'all' | 'matched' | 'unmatched'>('all');
  const [fetchingRemote, setFetchingRemote] = useState(false);
  const [recentRpis, setRecentRpis] = useState<number[]>([]);
  const [rpWithXml, setRpWithXml] = useState<number[]>([]);
  const [latestRpi, setLatestRpi] = useState<number | null>(null);
  const [selectedRpiNumber, setSelectedRpiNumber] = useState<string>('');
  const [updateDialogOpen, setUpdateDialogOpen] = useState(false);
  const [selectedEntry, setSelectedEntry] = useState<RpiEntry | null>(null);
  const [expandedEntryId, setExpandedEntryId] = useState<string | null>(null);
  const [newStage, setNewStage] = useState('');
  const [updating, setUpdating] = useState(false);
  const [assignDialogOpen, setAssignDialogOpen] = useState(false);
  const [assignEntry, setAssignEntry] = useState<RpiEntry | null>(null);
  const [clientSearch, setClientSearch] = useState('');
  const [availableClients, setAvailableClients] = useState<Profile[]>([]);
  const [selectedClient, setSelectedClient] = useState<Profile | null>(null);
  const [assignPriority, setAssignPriority] = useState<'urgent' | 'medium'>('medium');
  const [assigning, setAssigning] = useState(false);
  const [updatingTag, setUpdatingTag] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState('fetch');

  useEffect(() => {
    fetchUploads();
    fetchAvailableRpis();
    fetchClients();
  }, []);

  useEffect(() => {
    if (selectedUpload) fetchEntries(selectedUpload.id);
  }, [selectedUpload]);

  // â”€â”€â”€ Data fetching (unchanged logic) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const fetchClients = async () => {
    const { data } = await supabase.from('profiles').select('id, full_name, email, company_name').order('full_name');
    setAvailableClients(data || []);
  };

  const fetchAvailableRpis = async () => {
    try {
      const response = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/fetch-inpi-magazine`, {
        method: 'POST',
        body: JSON.stringify({ mode: 'list' }),
        headers: { 'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY}`, 'Content-Type': 'application/json' },
      });
      if (response.ok) {
        const data = await response.json();
        setRecentRpis(data.recentRpis || []);
        setRpWithXml(data.rpWithXml || []);
        setLatestRpi(data.latestRpi);
        const defaultRpi = data.rpWithXml?.[0] || data.latestRpi;
        setSelectedRpiNumber(defaultRpi?.toString() || '');
      }
    } catch (error) { console.error('Error fetching RPI list:', error); }
  };

  const fetchUploads = async () => {
    setLoading(true);
    const { data, error } = await supabase.from('rpi_uploads').select('*').order('created_at', { ascending: false });
    if (error) { toast.error('Erro ao carregar uploads'); console.error(error); }
    else {
      setUploads(data || []);
      if (data && data.length > 0 && !selectedUpload) setSelectedUpload(data[0]);
    }
    setLoading(false);
  };

  const fetchEntries = async (uploadId: string) => {
    const { data, error } = await supabase.from('rpi_entries').select('*').eq('rpi_upload_id', uploadId).order('created_at', { ascending: false });
    if (error) { toast.error('Erro ao carregar entradas'); return; }
    const entriesWithDetails = await Promise.all(
      (data || []).map(async (entry) => {
        let client = null, process = null;
        if (entry.matched_client_id) {
          const { data: p } = await supabase.from('profiles').select('full_name, email, company_name').eq('id', entry.matched_client_id).single();
          client = p;
        }
        if (entry.matched_process_id) {
          const { data: pr } = await supabase.from('brand_processes').select('pipeline_stage, status').eq('id', entry.matched_process_id).single();
          process = pr;
        }
        return { ...entry, client, process };
      })
    );
    setEntries(entriesWithDetails);
  };

  const handleRemoteFetch = async (rpiNumber?: number) => {
    setFetchingRemote(true);
    try {
      const targetRpi = rpiNumber || parseInt(selectedRpiNumber) || latestRpi;
      const response = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/fetch-inpi-magazine`, {
        method: 'POST',
        body: JSON.stringify({ rpiNumber: targetRpi }),
        headers: { 'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY}`, 'Content-Type': 'application/json' },
      });
      const result = await response.json();
      if (!response.ok) {
        if (result.error === 'XML_NOT_AVAILABLE' || result.error === 'XML_NOT_YET_AVAILABLE') {
          toast.info(result.message, { duration: 8000 });
          if (result.latestWithXml) { setSelectedRpiNumber(result.latestWithXml.toString()); toast.info(`Sugerimos buscar a RPI ${result.latestWithXml} que possui XML disponÃ­vel.`, { duration: 5000 }); }
        } else { toast.error(result.message || 'Erro ao buscar RPI'); }
        return;
      }
      if (result.totalProcesses === 0) { toast.info(result.message, { duration: 6000 }); }
      else { toast.success(`RPI ${result.rpiNumber} processada! ${result.totalProcesses} processos encontrados, ${result.matchedClients} clientes identificados.`); }
      await fetchUploads();
      if (result.uploadId) {
        const { data: newUpload } = await supabase.from('rpi_uploads').select('*').eq('id', result.uploadId).single();
        if (newUpload) { setSelectedUpload(newUpload); await fetchEntries(newUpload.id); }
      }
    } catch (error) { console.error('Remote fetch error:', error); toast.error('Erro ao buscar RPI do portal INPI'); }
    finally { setFetchingRemote(false); }
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const ext = file.name.split('.').pop()?.toLowerCase();
    if (!ext || !['pdf', 'xml', 'xlsx', 'xls'].includes(ext)) { toast.error('Envie um arquivo .pdf, .xml, .xlsx ou .xls'); return; }
    setUploading(true);
    try {
      const fileName = `rpi_${Date.now()}_${file.name}`;
      const { data: uploadData, error: uploadError } = await supabase.storage.from('documents').upload(`rpi/${fileName}`, file);
      if (uploadError) throw uploadError;
      const { data: signedUrlData, error: signedUrlError } = await supabase.storage.from('documents').createSignedUrl(uploadData.path, 3600);
      if (signedUrlError) throw signedUrlError;
      const { data: rpiUpload, error: insertError } = await supabase.from('rpi_uploads').insert({ file_name: file.name, file_path: uploadData.path, status: 'pending' }).select().single();
      if (insertError) throw insertError;
      toast.success('Arquivo enviado! Iniciando anÃ¡lise...');
      setSelectedUpload(rpiUpload);
      setUploads(prev => [rpiUpload, ...prev]);
      await processRpi(rpiUpload.id, signedUrlData.signedUrl);
    } catch (error) { console.error('Upload error:', error); toast.error('Erro ao enviar arquivo'); }
    finally { setUploading(false); }
  };

  const processRpi = async (rpiUploadId: string, fileUrl: string) => {
    setProcessing(true);
    try {
      const response = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/process-rpi`, {
        method: 'POST',
        body: JSON.stringify({ rpiUploadId, fileUrl }),
        headers: { 'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY}`, 'Content-Type': 'application/json' },
      });
      if (response.status === 429) { toast.error('Limite de requisiÃ§Ãµes excedido.'); await fetchUploads(); return; }
      if (response.status === 402) { toast.error('CrÃ©ditos de IA esgotados.'); await fetchUploads(); return; }
      if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || 'Erro ao processar arquivo'); }
      const result = await response.json();
      if (result.total_processes === 0) { toast.info(result.summary || 'Nenhum processo encontrado.', { duration: 6000 }); }
      else { toast.success(`AnÃ¡lise concluÃ­da! ${result.total_processes} processos encontrados, ${result.matched_clients} clientes identificados.`); }
      const { data: updatedUploads } = await supabase.from('rpi_uploads').select('*').order('created_at', { ascending: false });
      if (updatedUploads) {
        setUploads(updatedUploads);
        const processedUpload = updatedUploads.find(u => u.id === rpiUploadId);
        if (processedUpload) { setSelectedUpload(processedUpload); await fetchEntries(rpiUploadId); }
      }
    } catch (error) {
      console.error('Process error:', error);
      toast.error(error instanceof Error ? error.message : 'Erro ao processar revista.');
      await supabase.from('rpi_uploads').update({ status: 'error' }).eq('id', rpiUploadId);
      await fetchUploads();
    } finally { setProcessing(false); }
  };

  const handleOpenUpdateDialog = (entry: RpiEntry, e?: React.MouseEvent) => {
    e?.stopPropagation();
    setSelectedEntry(entry);
    setNewStage(suggestStage(entry.dispatch_code, entry.dispatch_text));
    setUpdateDialogOpen(true);
  };

  const handleUpdateProcess = async () => {
    if (!selectedEntry || !newStage) return;
    setUpdating(true);
    try {
      if (selectedEntry.matched_process_id) {
        const { error } = await supabase.from('brand_processes').update({ pipeline_stage: newStage, status: 'em_andamento', updated_at: new Date().toISOString() }).eq('id', selectedEntry.matched_process_id);
        if (error) throw error;
      }
      const { error: entryError } = await supabase.from('rpi_entries').update({ update_status: 'updated', updated_at: new Date().toISOString() }).eq('id', selectedEntry.id);
      if (entryError) throw entryError;
      if (selectedEntry.matched_client_id) {
        await supabase.from('notifications').insert({ user_id: selectedEntry.matched_client_id, title: 'AtualizaÃ§Ã£o do Processo', message: `Seu processo da marca \"${selectedEntry.brand_name}\" foi atualizado com base na RPI.`, type: 'info', link: '/cliente/processos' });
        const { data: { user } } = await supabase.auth.getUser();
        await supabase.from('client_activities').insert({ user_id: selectedEntry.matched_client_id, admin_id: user?.id, activity_type: 'process_update', description: `Processo atualizado via RPI para etapa: ${PIPELINE_STAGES.find(s => s.value === newStage)?.label}` });
      }
      toast.success('Processo atualizado com sucesso!');
      setUpdateDialogOpen(false);
      if (selectedUpload) await fetchEntries(selectedUpload.id);
    } catch (error) { console.error('Update error:', error); toast.error('Erro ao atualizar processo'); }
    finally { setUpdating(false); }
  };

  const handleOpenAssignDialog = (entry: RpiEntry, e?: React.MouseEvent) => {
    e?.stopPropagation();
    setAssignEntry(entry);
    setClientSearch('');
    setSelectedClient(null);
    setAssignPriority('medium');
    setAssignDialogOpen(true);
  };

  const filteredClients = availableClients.filter(client => {
    if (!clientSearch) return true;
    const s = clientSearch.toLowerCase();
    return client.full_name?.toLowerCase().includes(s) || client.email?.toLowerCase().includes(s) || client.company_name?.toLowerCase().includes(s);
  });

  const handleAssignClient = async () => {
    if (!assignEntry || !selectedClient) return;
    setAssigning(true);
    try {
      const deadlineDate = new Date();
      deadlineDate.setDate(deadlineDate.getDate() + 60);
      const { error: entryError } = await supabase.from('rpi_entries').update({ matched_client_id: selectedClient.id, update_status: 'pending', updated_at: new Date().toISOString() }).eq('id', assignEntry.id);
      if (entryError) throw entryError;
      await supabase.from('notifications').insert({ user_id: selectedClient.id, title: assignPriority === 'urgent' ? 'ğŸš¨ URGENTE: Nova PublicaÃ§Ã£o INPI' : 'Nova PublicaÃ§Ã£o INPI', message: `Uma publicaÃ§Ã£o referente ao processo ${assignEntry.process_number} (${assignEntry.brand_name || 'Marca'}) foi vinculada ao seu perfil. Prazo: 60 dias.`, type: assignPriority === 'urgent' ? 'warning' : 'info', link: '/cliente/processos' });
      const { data: { user } } = await supabase.auth.getUser();
      await supabase.from('client_activities').insert({ user_id: selectedClient.id, admin_id: user?.id, activity_type: 'rpi_publication', description: `PublicaÃ§Ã£o RPI vinculada: ${assignEntry.brand_name} - ${assignEntry.dispatch_type}. Prioridade: ${assignPriority === 'urgent' ? 'Urgente' : 'MÃ©dia'}. Prazo: 60 dias.`, metadata: { process_number: assignEntry.process_number, dispatch_code: assignEntry.dispatch_code, dispatch_text: assignEntry.dispatch_text, deadline_date: deadlineDate.toISOString(), priority: assignPriority } });
      toast.success(`PublicaÃ§Ã£o vinculada ao cliente ${selectedClient.full_name || selectedClient.email}!`);
      setAssignDialogOpen(false);
      if (selectedUpload) await fetchEntries(selectedUpload.id);
    } catch (error) { console.error('Assign error:', error); toast.error('Erro ao vincular cliente'); }
    finally { setAssigning(false); }
  };

  const handleUpdateTag = async (entryId: string, newTag: string) => {
    setUpdatingTag(entryId);
    try {
      const { error } = await supabase.from('rpi_entries').update({ tag: newTag, updated_at: new Date().toISOString() }).eq('id', entryId);
      if (error) throw error;
      toast.success('TAG atualizada');
      setEntries(prev => prev.map(e => e.id === entryId ? { ...e, tag: newTag } : e));
    } catch (error) { toast.error('Erro ao atualizar TAG'); }
    finally { setUpdatingTag(null); }
  };

  const filteredEntries = entries.filter(entry => {
    const matchesSearch = entry.brand_name?.toLowerCase().includes(searchTerm.toLowerCase()) || entry.process_number?.includes(searchTerm) || entry.holder_name?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesFilter = filterMatched === 'all' || (filterMatched === 'matched' && entry.matched_client_id) || (filterMatched === 'unmatched' && !entry.matched_client_id);
    return matchesSearch && matchesFilter;
  });

  const matchedEntries = entries.filter(e => e.matched_client_id);
  const deferimentos = entries.filter(e => (e.dispatch_text || '').toLowerCase().includes('deferid'));
  const indeferimentos = entries.filter(e => (e.dispatch_text || '').toLowerCase().includes('indeferid'));

  return (
    <AdminLayout>
      <div className="space-y-8">
        {/* â•â•â• HERO HEADER â•â•â• */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-[#0f172a] via-[#1e293b] to-[#0f172a] p-8 lg:p-10"
        >
          {/* Background effects */}
          <div className="absolute inset-0 overflow-hidden">
            <div className="absolute -top-40 -right-40 w-80 h-80 bg-primary/20 rounded-full blur-3xl" />
            <div className="absolute -bottom-20 -left-20 w-60 h-60 bg-blue-600/15 rounded-full blur-3xl" />
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl" />
            {/* Grid pattern */}
            <div className="absolute inset-0 opacity-[0.03]" style={{
              backgroundImage: 'linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)',
              backgroundSize: '40px 40px'
            }} />
          </div>

          <div className="relative flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <div className="p-3 rounded-xl bg-primary/20 backdrop-blur-sm border border-primary/20">
                  <Newspaper className="h-7 w-7 text-primary" />
                </div>
                <div>
                  <h1 className="text-2xl lg:text-3xl font-bold text-white tracking-tight">
                    Revista INPI
                  </h1>
                  <p className="text-white/50 text-sm font-medium">
                    Revista da Propriedade Industrial â€” AnÃ¡lise Inteligente
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-3 flex-wrap">
                <Badge className="bg-emerald-500/20 text-emerald-300 border-emerald-500/30 gap-1.5">
                  <Radio className="h-3 w-3 animate-pulse" />
                  Sistema Online
                </Badge>
                {latestRpi && (
                  <Badge className="bg-white/10 text-white/70 border-white/10 gap-1.5">
                    <Hash className="h-3 w-3" />
                    Ãšltima RPI: {latestRpi}
                  </Badge>
                )}
                <Badge className="bg-white/10 text-white/70 border-white/10 gap-1.5">
                  <Database className="h-3 w-3" />
                  {uploads.length} ediÃ§Ãµes processadas
                </Badge>
              </div>
            </div>

            <div className="flex items-center gap-3">
              <Label
                htmlFor="pdf-upload"
                className={`flex items-center gap-2 px-5 py-2.5 rounded-xl cursor-pointer transition-all text-sm font-medium ${
                  uploading || processing
                    ? 'bg-white/10 text-white/40 cursor-not-allowed'
                    : 'bg-white/10 text-white hover:bg-white/20 border border-white/10'
                }`}
              >
                {uploading || processing ? <Loader2 className="h-4 w-4 animate-spin" /> : <Upload className="h-4 w-4" />}
                {uploading ? 'Enviando...' : processing ? 'Analisando...' : 'Upload Manual'}
              </Label>
              <Input id="pdf-upload" type="file" accept=".pdf,.xml,.xlsx,.xls" onChange={handleFileUpload} disabled={uploading || processing} className="hidden" />
              
              <Button
                onClick={() => handleRemoteFetch(rpWithXml[0] || latestRpi || undefined)}
                disabled={fetchingRemote || (!latestRpi && rpWithXml.length === 0)}
                size="lg"
                className="gap-2 bg-primary hover:bg-primary/90 text-primary-foreground shadow-lg shadow-primary/25 rounded-xl"
              >
                {fetchingRemote ? <Loader2 className="h-5 w-5 animate-spin" /> : <Zap className="h-5 w-5" />}
                Buscar Ãšltima RPI
              </Button>
            </div>
          </div>
        </motion.div>

        {/* â•â•â• STATS â•â•â• */}
        {selectedUpload && selectedUpload.status === 'completed' && (
          <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
            <StatCard icon={FileText} label="NÂº da RPI" value={selectedUpload.rpi_number || 'N/A'} gradient="bg-gradient-to-br from-violet-600 to-purple-700" delay={0.1} />
            <StatCard icon={Calendar} label="Data RPI" value={selectedUpload.rpi_date ? format(new Date(selectedUpload.rpi_date), "dd/MM/yy", { locale: ptBR }) : 'â€”'} gradient="bg-gradient-to-br from-blue-600 to-indigo-700" delay={0.15} />
            <StatCard icon={Search} label="Processos" value={selectedUpload.total_processes_found} gradient="bg-gradient-to-br from-cyan-600 to-teal-700" delay={0.2} />
            <StatCard icon={Users} label="Clientes" value={matchedEntries.length} gradient="bg-gradient-to-br from-emerald-600 to-green-700" delay={0.25} />
            <StatCard icon={AlertTriangle} label="Sem VÃ­nculo" value={entries.length - matchedEntries.length} gradient="bg-gradient-to-br from-amber-600 to-orange-700" delay={0.3} />
          </div>
        )}

        {/* â•â•â• MAIN TABS â•â•â• */}
        <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="bg-muted/50 p-1 rounded-xl h-auto flex-wrap">
            <TabsTrigger value="fetch" className="gap-2 rounded-lg data-[state=active]:shadow-sm">
              <Globe className="h-4 w-4" />
              Busca Remota
            </TabsTrigger>
            <TabsTrigger value="results" className="gap-2 rounded-lg data-[state=active]:shadow-sm">
              <Layers className="h-4 w-4" />
              Processos
              {entries.length > 0 && (
                <Badge variant="secondary" className="ml-1 text-xs h-5 px-1.5">{entries.length}</Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="history" className="gap-2 rounded-lg data-[state=active]:shadow-sm">
              <Clock className="h-4 w-4" />
              HistÃ³rico
            </TabsTrigger>
          </TabsList>

          {/* â”€â”€â”€ TAB: Busca Remota â”€â”€â”€ */}
          <TabsContent value="fetch" className="space-y-6">
            <motion.div initial={{ opacity: 0, y: 16 }} animate={{ opacity: 1, y: 0 }}>
              <Card className="border-primary/20 overflow-hidden relative">
                <div className="absolute top-0 right-0 w-72 h-72 bg-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" />
                <CardHeader className="relative">
                  <CardTitle className="flex items-center gap-2 text-lg">
                    <Globe className="h-5 w-5 text-primary" />
                    Portal INPI â€” Busca AutomÃ¡tica
                    <Badge variant="secondary" className="ml-2 gap-1">
                      <Wifi className="h-3 w-3" />
                      Live
                    </Badge>
                  </CardTitle>
                  <CardDescription>
                    Selecione a ediÃ§Ã£o da RPI e baixe automaticamente do portal oficial do INPI
                  </CardDescription>
                </CardHeader>
                <CardContent className="relative space-y-6">
                  <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-end">
                    <div className="flex-1 space-y-2">
                      <Label>EdiÃ§Ã£o da RPI</Label>
                      <div className="flex gap-3">
                        <Select value={selectedRpiNumber} onValueChange={setSelectedRpiNumber}>
                          <SelectTrigger className="w-72 rounded-xl">
                            <SelectValue placeholder="Selecione a RPI" />
                          </SelectTrigger>
                          <SelectContent>
                            {recentRpis.map(rpi => {
                              const hasXml = rpWithXml.includes(rpi);
                              return (
                                <SelectItem key={rpi} value={rpi.toString()}>
                                  <span className="flex items-center gap-2">
                                    RPI {rpi}
                                    {rpi === latestRpi && <Badge variant="secondary" className="text-xs">Ãšltima</Badge>}
                                    {hasXml ? (
                                      <Badge className="text-xs bg-emerald-500/10 text-emerald-600 border-emerald-500/20">XML âœ“</Badge>
                                    ) : (
                                      <Badge variant="outline" className="text-xs text-muted-foreground">Sem XML</Badge>
                                    )}
                                  </span>
                                </SelectItem>
                              );
                            })}
                          </SelectContent>
                        </Select>

                        <Button
                          onClick={() => handleRemoteFetch()}
                          disabled={fetchingRemote || !selectedRpiNumber}
                          className="gap-2 rounded-xl"
                        >
                          {fetchingRemote ? <Loader2 className="h-4 w-4 animate-spin" /> : <CloudDownload className="h-4 w-4" />}
                          Buscar
                        </Button>
                      </div>
                      {!rpWithXml.includes(parseInt(selectedRpiNumber)) && selectedRpiNumber && (
                        <p className="text-xs text-amber-600 flex items-center gap-1">
                          <AlertTriangle className="h-3 w-3" />
                          Esta RPI ainda nÃ£o possui XML de Marcas disponÃ­vel
                        </p>
                      )}
                    </div>
                  </div>

                  {/* Info banner */}
                  <div className="rounded-xl bg-muted/50 p-4 flex items-start gap-3">
                    <Shield className="h-5 w-5 text-primary mt-0.5 flex-shrink-0" />
                    <div className="space-y-1">
                      <p className="text-sm font-medium">Como funciona</p>
                      <p className="text-xs text-muted-foreground leading-relaxed">
                        O sistema conecta diretamente ao portal <strong>revistas.inpi.gov.br</strong> e baixa o arquivo XML da seÃ§Ã£o de Marcas.
                        Em seguida, identifica automaticamente todos os processos do procurador <strong>Davilys Danques Oliveira Cunha</strong> e 
                        cruza com sua base de clientes para notificaÃ§Ã£o imediata.
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          </TabsContent>

          {/* â”€â”€â”€ TAB: Processos â”€â”€â”€ */}
          <TabsContent value="results" className="space-y-4">
            {/* Processing Indicator */}
            <AnimatePresence>
              {(processing || fetchingRemote) && (
                <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} exit={{ opacity: 0, height: 0 }}>
                  <Card className="border-primary/30 bg-gradient-to-r from-primary/5 to-transparent overflow-hidden">
                    <CardContent className="py-8">
                      <div className="flex items-center gap-6">
                        <div className="relative">
                          <div className="absolute inset-0 animate-ping opacity-20 rounded-full bg-primary" />
                          <div className="relative p-4 rounded-full bg-primary/10">
                            <Loader2 className="h-8 w-8 text-primary animate-spin" />
                          </div>
                        </div>
                        <div className="flex-1 space-y-3">
                          <h3 className="font-semibold text-lg">
                            {fetchingRemote ? 'Conectando ao Portal INPI...' : 'Analisando Revista...'}
                          </h3>
                          <div className="space-y-1.5">
                            {(fetchingRemote ? [
                              'Conectando ao portal INPI...',
                              'Baixando arquivo XML...',
                              'Processando dados estruturados...',
                            ] : [
                              'Identificando formato do arquivo',
                              'Aplicando OCR para PDFs digitalizados',
                              'Extraindo processos do procurador',
                              'Cruzando com base de clientes',
                            ]).map((step, i) => (
                              <motion.p
                                key={i}
                                initial={{ opacity: 0, x: -10 }}
                                animate={{ opacity: 1, x: 0 }}
                                transition={{ delay: i * 0.3 }}
                                className="text-sm text-muted-foreground flex items-center gap-2"
                              >
                                <Activity className="h-3 w-3 text-primary" />
                                {step}
                              </motion.p>
                            ))}
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </motion.div>
              )}
            </AnimatePresence>

            {/* Entries List */}
            {selectedUpload && (selectedUpload.status === 'completed' || entries.length > 0) && (
              <>
                {/* Search & Filters Bar */}
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                  <div>
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <Layers className="h-5 w-5 text-primary" />
                      Processos Identificados
                    </h2>
                    <p className="text-sm text-muted-foreground">
                      {matchedEntries.length > 0
                        ? `${matchedEntries.length} de ${entries.length} vinculados a clientes`
                        : `${entries.length} processos encontrados`}
                    </p>
                  </div>
                  <div className="flex items-center gap-3">
                    <div className="relative">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        placeholder="Buscar marca, processo..."
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        className="pl-9 w-64 rounded-xl"
                      />
                    </div>
                    <Select value={filterMatched} onValueChange={(v: any) => setFilterMatched(v)}>
                      <SelectTrigger className="w-44 rounded-xl">
                        <Filter className="h-4 w-4 mr-2" />
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">Todos</SelectItem>
                        <SelectItem value="matched">Clientes WebMarcas</SelectItem>
                        <SelectItem value="unmatched">NÃ£o identificados</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* Process Cards */}
                <div className="space-y-3">
                  <AnimatePresence mode="popLayout">
                    {filteredEntries.map((entry, index) => {
                      const isExpanded = expandedEntryId === entry.id;
                      const tagOption = TAG_OPTIONS.find(t => t.value === (entry.tag || 'pending'));

                      return (
                        <motion.div
                          key={entry.id}
                          layout
                          initial={{ opacity: 0, y: 16 }}
                          animate={{ opacity: 1, y: 0 }}
                          exit={{ opacity: 0, scale: 0.95 }}
                          transition={{ delay: Math.min(index * 0.04, 0.4), duration: 0.35 }}
                        >
                          <Card
                            className={`group cursor-pointer transition-all duration-300 overflow-hidden ${
                              isExpanded
                                ? 'border-primary/40 shadow-lg shadow-primary/5 ring-1 ring-primary/10'
                                : 'hover:border-primary/20 hover:shadow-md'
                            }`}
                            onClick={() => setExpandedEntryId(isExpanded ? null : entry.id)}
                          >
                            {/* Card Header Row */}
                            <div className="px-5 py-4 flex items-center gap-4">
                              {/* Status indicator */}
                              <div className={`relative flex-shrink-0 w-11 h-11 rounded-xl flex items-center justify-center ${
                                entry.update_status === 'updated'
                                  ? 'bg-emerald-500/10'
                                  : entry.matched_client_id
                                  ? 'bg-primary/10'
                                  : 'bg-muted'
                              }`}>
                                {entry.update_status === 'updated' ? (
                                  <CheckCircle className="h-5 w-5 text-emerald-600" />
                                ) : (
                                  <FileText className="h-5 w-5 text-primary" />
                                )}
                                {entry.matched_client_id && entry.update_status !== 'updated' && (
                                  <span className="absolute -top-0.5 -right-0.5 h-3 w-3 rounded-full bg-emerald-500 border-2 border-card animate-pulse" />
                                )}
                              </div>

                              {/* Brand & Process */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="font-bold text-foreground truncate max-w-[200px]">
                                    {entry.brand_name || 'Marca nÃ£o identificada'}
                                  </span>
                                  <code className="text-[11px] font-mono bg-muted/70 px-2 py-0.5 rounded-md text-muted-foreground">
                                    {entry.process_number}
                                  </code>
                                  {entry.ncl_classes && entry.ncl_classes.length > 0 && (
                                    <Badge variant="secondary" className="font-mono text-[10px] h-5">
                                      NCL {entry.ncl_classes.join(', ')}
                                    </Badge>
                                  )}
                                </div>
                                <p className="text-xs text-muted-foreground mt-0.5 line-clamp-1">
                                  {entry.dispatch_text || entry.dispatch_type || 'Sem descriÃ§Ã£o do despacho'}
                                </p>
                              </div>

                              {/* Right side badges */}
                              <div className="flex items-center gap-2 flex-shrink-0">
                                {getDispatchBadge(entry.dispatch_type)}
                                {tagOption && (
                                  <Badge className={`${tagOption.color} text-[10px] border-0`}>
                                    {tagOption.label}
                                  </Badge>
                                )}
                                {entry.matched_client_id ? (
                                  <Badge className="bg-emerald-500/10 text-emerald-600 border-emerald-500/20 text-[10px] gap-1">
                                    <Users className="h-3 w-3" />
                                    {entry.client?.full_name?.split(' ')[0] || 'Cliente'}
                                  </Badge>
                                ) : (
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    className="h-7 text-xs gap-1.5 rounded-lg border-primary/30 text-primary hover:bg-primary/10"
                                    onClick={(e) => handleOpenAssignDialog(entry, e)}
                                  >
                                    <UserPlus className="h-3 w-3" />
                                    Vincular
                                  </Button>
                                )}
                                <motion.div
                                  animate={{ rotate: isExpanded ? 90 : 0 }}
                                  transition={{ duration: 0.2 }}
                                >
                                  <ArrowRight className="h-4 w-4 text-muted-foreground" />
                                </motion.div>
                              </div>
                            </div>

                            {/* Expanded Detail Panel */}
                            <AnimatePresence>
                              {isExpanded && (
                                <motion.div
                                  initial={{ height: 0, opacity: 0 }}
                                  animate={{ height: 'auto', opacity: 1 }}
                                  exit={{ height: 0, opacity: 0 }}
                                  transition={{ duration: 0.3, ease: 'easeInOut' }}
                                  className="overflow-hidden"
                                  onClick={e => e.stopPropagation()}
                                >
                                  <div className="border-t border-border/50 bg-gradient-to-b from-muted/30 to-transparent">
                                    <div className="p-5 space-y-5">
                                      {/* Detail Grid */}
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* Column 1: Process Info */}
                                        <div className="space-y-3">
                                          <h4 className="text-xs font-semibold uppercase text-muted-foreground tracking-wider flex items-center gap-1.5">
                                            <FileText className="h-3.5 w-3.5" />
                                            Dados do Processo
                                          </h4>
                                          <div className="space-y-2.5 bg-card rounded-xl p-4 border border-border/50">
                                            <DetailRow label="NÂº Processo" value={entry.process_number} mono />
                                            <DetailRow label="Marca" value={entry.brand_name || 'â€”'} />
                                            <DetailRow label="Classe NCL" value={entry.ncl_classes?.join(', ') || 'â€”'} />
                                            <DetailRow label="Titular" value={entry.holder_name || 'â€”'} />
                                            {entry.publication_date && (
                                              <DetailRow label="PublicaÃ§Ã£o" value={format(new Date(entry.publication_date), "dd/MM/yyyy", { locale: ptBR })} />
                                            )}
                                          </div>
                                        </div>

                                        {/* Column 2: Dispatch Details */}
                                        <div className="space-y-3">
                                          <h4 className="text-xs font-semibold uppercase text-muted-foreground tracking-wider flex items-center gap-1.5">
                                            <Sparkles className="h-3.5 w-3.5" />
                                            Despacho
                                          </h4>
                                          <div className="space-y-2.5 bg-card rounded-xl p-4 border border-border/50">
                                            <DetailRow label="Tipo" value={entry.dispatch_type || 'â€”'} />
                                            <DetailRow label="CÃ³digo" value={entry.dispatch_code || 'â€”'} mono />
                                            <div>
                                              <span className="text-[11px] text-muted-foreground">Texto do Despacho</span>
                                              <p className="text-sm mt-1 leading-relaxed text-foreground">
                                                {entry.dispatch_text || 'Sem descriÃ§Ã£o disponÃ­vel'}
                                              </p>
                                            </div>
                                            <div className="pt-1">
                                              <span className="text-[11px] text-muted-foreground">Etapa Sugerida</span>
                                              <div className="mt-1">
                                                <Badge className="bg-primary/10 text-primary border-primary/20">
                                                  {PIPELINE_STAGES.find(s => s.value === suggestStage(entry.dispatch_code, entry.dispatch_text))?.label || 'Protocolado'}
                                                </Badge>
                                              </div>
                                            </div>
                                          </div>
                                        </div>

                                        {/* Column 3: Client & Actions */}
                                        <div className="space-y-3">
                                          <h4 className="text-xs font-semibold uppercase text-muted-foreground tracking-wider flex items-center gap-1.5">
                                            <Users className="h-3.5 w-3.5" />
                                            Cliente & AÃ§Ãµes
                                          </h4>
                                          <div className="space-y-3 bg-card rounded-xl p-4 border border-border/50">
                                            {entry.matched_client_id ? (
                                              <div className="space-y-2">
                                                <div className="flex items-center gap-3">
                                                  <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                                                    <span className="text-sm font-bold text-primary">
                                                      {(entry.client?.full_name || entry.client?.email || '?')[0].toUpperCase()}
                                                    </span>
                                                  </div>
                                                  <div>
                                                    <p className="font-semibold text-sm">{entry.client?.full_name || 'Cliente'}</p>
                                                    <p className="text-xs text-muted-foreground">{entry.client?.email}</p>
                                                    {entry.client?.company_name && (
                                                      <p className="text-xs text-muted-foreground flex items-center gap-1">
                                                        <Building2 className="h-3 w-3" />
                                                        {entry.client.company_name}
                                                      </p>
                                                    )}
                                                  </div>
                                                </div>
                                                {entry.process?.pipeline_stage && (
                                                  <div className="pt-1">
                                                    <span className="text-[11px] text-muted-foreground">Etapa Atual</span>
                                                    <div className="mt-1">
                                                      <Badge variant="outline">
                                                        {PIPELINE_STAGES.find(s => s.value === entry.process?.pipeline_stage)?.label || entry.process.pipeline_stage}
                                                      </Badge>
                                                    </div>
                                                  </div>
                                                )}
                                              </div>
                                            ) : (
                                              <div className="text-center py-4 space-y-2">
                                                <div className="mx-auto w-10 h-10 rounded-full bg-muted flex items-center justify-center">
                                                  <UserPlus className="h-5 w-5 text-muted-foreground" />
                                                </div>
                                                <p className="text-xs text-muted-foreground">Nenhum cliente vinculado</p>
                                              </div>
                                            )}

                                            {/* TAG Selector */}
                                            <div className="pt-2 border-t border-border/30">
                                              <span className="text-[11px] text-muted-foreground">TAG</span>
                                              <Select value={entry.tag || 'pending'} onValueChange={(value) => handleUpdateTag(entry.id, value)} disabled={updatingTag === entry.id}>
                                                <SelectTrigger className="w-full h-9 rounded-lg text-xs mt-1">
                                                  {updatingTag === entry.id ? <Loader2 className="h-3 w-3 animate-spin" /> : <SelectValue />}
                                                </SelectTrigger>
                                                <SelectContent>
                                                  {TAG_OPTIONS.map(opt => (
                                                    <SelectItem key={opt.value} value={opt.value}>
                                                      <Badge className={`${opt.color} text-xs border-0`}>{opt.label}</Badge>
                                                    </SelectItem>
                                                  ))}
                                                </SelectContent>
                                              </Select>
                                            </div>
                                          </div>

                                          {/* Action Buttons */}
                                          <div className="flex flex-col gap-2">
                                            {entry.matched_client_id && entry.update_status !== 'updated' && (
                                              <Button size="sm" onClick={(e) => handleOpenUpdateDialog(entry, e)} className="gap-2 rounded-xl w-full">
                                                <RefreshCw className="h-4 w-4" />
                                                Atualizar Processo
                                              </Button>
                                            )}
                                            {!entry.matched_client_id && (
                                              <Button size="sm" variant="outline" onClick={(e) => handleOpenAssignDialog(entry, e)} className="gap-2 rounded-xl w-full">
                                                <UserPlus className="h-4 w-4" />
                                                Vincular Cliente
                                              </Button>
                                            )}
                                            {entry.update_status === 'updated' && (
                                              <div className="flex items-center justify-center gap-2 py-2 rounded-xl bg-emerald-500/5 border border-emerald-500/20">
                                                <CheckCircle className="h-4 w-4 text-emerald-600" />
                                                <span className="text-sm font-medium text-emerald-600">Processo Atualizado</span>
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </motion.div>
                              )}
                            </AnimatePresence>
                          </Card>
                        </motion.div>
                      );
                    })}
                  </AnimatePresence>

                  {filteredEntries.length === 0 && !processing && !fetchingRemote && (
                    <Card className="border-dashed border-2">
                      <CardContent className="py-16 text-center">
                        <div className="mx-auto w-16 h-16 rounded-2xl bg-muted/50 flex items-center justify-center mb-4">
                          <Search className="h-8 w-8 text-muted-foreground/40" />
                        </div>
                        <p className="text-muted-foreground font-medium">Nenhum processo encontrado</p>
                        {searchTerm && <p className="text-xs text-muted-foreground mt-1">Tente buscar com termos diferentes</p>}
                      </CardContent>
                    </Card>
                  )}
                </div>
              </>
            )}

            {/* Empty state */}
            {!loading && entries.length === 0 && !processing && !fetchingRemote && (
              <Card className="border-dashed border-2">
                <CardContent className="py-20 text-center">
                  <div className="mx-auto w-20 h-20 rounded-2xl bg-primary/5 flex items-center justify-center mb-6">
                    <Newspaper className="h-10 w-10 text-primary/40" />
                  </div>
                  <h3 className="text-xl font-semibold mb-2">Nenhum processo carregado</h3>
                  <p className="text-muted-foreground mb-8 max-w-md mx-auto">
                    Busque a RPI mais recente do portal INPI ou faÃ§a upload manual para comeÃ§ar a anÃ¡lise.
                  </p>
                  <div className="flex gap-3 justify-center">
                    <Button onClick={() => { setActiveTab('fetch'); }} variant="outline" className="gap-2 rounded-xl">
                      <Globe className="h-4 w-4" />
                      Ir para Busca Remota
                    </Button>
                  </div>
                </CardContent>
              </Card>
            )}
          </TabsContent>

          {/* â”€â”€â”€ TAB: HistÃ³rico â”€â”€â”€ */}
          <TabsContent value="history" className="space-y-4">
            {uploads.length > 0 ? (
              <div className="grid gap-3">
                {uploads.map((upload, index) => (
                  <motion.div
                    key={upload.id}
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.05 }}
                  >
                    <Card
                      className={`cursor-pointer transition-all hover:shadow-md ${
                        selectedUpload?.id === upload.id
                          ? 'border-primary/50 bg-primary/[0.02] shadow-sm'
                          : 'hover:border-primary/20'
                      }`}
                      onClick={() => { setSelectedUpload(upload); setActiveTab('results'); }}
                    >
                      <CardContent className="py-4">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-4">
                            <div className={`p-2.5 rounded-xl ${
                              upload.status === 'completed' ? 'bg-emerald-500/10 text-emerald-600' :
                              upload.status === 'error' ? 'bg-red-500/10 text-red-600' :
                              'bg-amber-500/10 text-amber-600'
                            }`}>
                              {upload.status === 'completed' ? <CheckCircle className="h-5 w-5" /> :
                               upload.status === 'error' ? <AlertCircle className="h-5 w-5" /> :
                               <Loader2 className="h-5 w-5 animate-spin" />}
                            </div>
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="font-semibold">RPI {upload.rpi_number || 'â€”'}</span>
                                {upload.rpi_date && (
                                  <Badge variant="outline" className="text-xs">
                                    {format(new Date(upload.rpi_date), "dd/MM/yyyy", { locale: ptBR })}
                                  </Badge>
                                )}
                                <Badge className={
                                  upload.status === 'completed' ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/20' :
                                  upload.status === 'error' ? 'bg-red-500/10 text-red-600 border-red-500/20' :
                                  'bg-amber-500/10 text-amber-600 border-amber-500/20'
                                }>
                                  {upload.status === 'completed' ? 'Processada' : upload.status === 'error' ? 'Erro' : 'Pendente'}
                                </Badge>
                              </div>
                              <p className="text-xs text-muted-foreground mt-1">
                                {upload.file_name} â€¢ {format(new Date(upload.created_at), "dd/MM/yy HH:mm", { locale: ptBR })}
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-4 text-right">
                            {upload.status === 'completed' && (
                              <div className="flex items-center gap-4">
                                <div>
                                  <p className="text-lg font-bold">{upload.total_processes_found}</p>
                                  <p className="text-xs text-muted-foreground">processos</p>
                                </div>
                                <div>
                                  <p className="text-lg font-bold text-emerald-600">{upload.total_clients_matched}</p>
                                  <p className="text-xs text-muted-foreground">clientes</p>
                                </div>
                              </div>
                            )}
                            <ArrowRight className="h-4 w-4 text-muted-foreground" />
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </motion.div>
                ))}
              </div>
            ) : (
              <Card className="border-dashed border-2">
                <CardContent className="py-16 text-center">
                  <Clock className="h-12 w-12 mx-auto text-muted-foreground/40 mb-4" />
                  <h3 className="text-lg font-semibold mb-2">Nenhum histÃ³rico</h3>
                  <p className="text-sm text-muted-foreground">As RPIs processadas aparecerÃ£o aqui.</p>
                </CardContent>
              </Card>
            )}
          </TabsContent>
        </Tabs>

        {/* Loading */}
        {loading && (
          <div className="space-y-4">
            <Skeleton className="h-32 w-full rounded-2xl" />
            <Skeleton className="h-64 w-full rounded-2xl" />
          </div>
        )}
      </div>

      {/* â•â•â• DIALOGS â•â•â• */}
      
      {/* Update Dialog */}
      <Dialog open={updateDialogOpen} onOpenChange={setUpdateDialogOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <RefreshCw className="h-5 w-5 text-primary" />
              Atualizar Processo
            </DialogTitle>
            <DialogDescription>Confirme a atualizaÃ§Ã£o do processo com base na publicaÃ§Ã£o da RPI.</DialogDescription>
          </DialogHeader>
          {selectedEntry && (
            <div className="space-y-4">
              <div className="rounded-xl bg-muted/50 p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Marca</span>
                  <span className="font-semibold">{selectedEntry.brand_name}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Processo</span>
                  <span className="font-mono text-sm">{selectedEntry.process_number}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Despacho</span>
                  {getDispatchBadge(selectedEntry.dispatch_type)}
                </div>
                {selectedEntry.client && (
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Cliente</span>
                    <span className="font-medium">{selectedEntry.client.full_name || selectedEntry.client.company_name}</span>
                  </div>
                )}
              </div>
              <div className="space-y-2">
                <Label>Etapa do Funil</Label>
                <div className="flex items-center gap-3">
                  <div className="flex-1">
                    {selectedEntry.process?.pipeline_stage && (
                      <Badge variant="outline" className="mb-2">
                        Atual: {PIPELINE_STAGES.find(s => s.value === selectedEntry.process?.pipeline_stage)?.label || selectedEntry.process.pipeline_stage}
                      </Badge>
                    )}
                  </div>
                  <ArrowRight className="h-4 w-4 text-muted-foreground" />
                  <div className="flex-1">
                    <Select value={newStage} onValueChange={setNewStage}>
                      <SelectTrigger className="rounded-xl"><SelectValue placeholder="Nova etapa" /></SelectTrigger>
                      <SelectContent>
                        {PIPELINE_STAGES.map(stage => (<SelectItem key={stage.value} value={stage.value}>{stage.label}</SelectItem>))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                {suggestStage(selectedEntry.dispatch_code, selectedEntry.dispatch_text) === newStage && (
                  <p className="text-xs text-emerald-600 flex items-center gap-1"><CheckCircle className="h-3 w-3" />Etapa sugerida automaticamente</p>
                )}
              </div>
            </div>
          )}
          <DialogFooter>
            <Button variant="outline" onClick={() => setUpdateDialogOpen(false)} className="rounded-xl">Cancelar</Button>
            <Button onClick={handleUpdateProcess} disabled={updating || !newStage} className="rounded-xl gap-2">
              {updating ? <Loader2 className="h-4 w-4 animate-spin" /> : <CheckCircle className="h-4 w-4" />}
              Confirmar
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Assign Client Dialog */}
      <Dialog open={assignDialogOpen} onOpenChange={setAssignDialogOpen}>
        <DialogContent className="sm:max-w-lg">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <UserPlus className="h-5 w-5 text-primary" />
              Vincular Cliente
            </DialogTitle>
            <DialogDescription>Selecione o cliente para vincular a esta publicaÃ§Ã£o RPI. Prazo de 60 dias.</DialogDescription>
          </DialogHeader>
          {assignEntry && (
            <div className="space-y-4">
              <div className="rounded-xl bg-muted/50 p-4 space-y-2">
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Marca</span>
                  <span className="font-semibold">{assignEntry.brand_name || '-'}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Processo</span>
                  <span className="font-mono text-sm">{assignEntry.process_number}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Titular</span>
                  <span className="text-sm">{assignEntry.holder_name || '-'}</span>
                </div>
                <div className="flex items-start justify-between">
                  <span className="text-sm text-muted-foreground">Despacho</span>
                  <div className="text-right">
                    {getDispatchBadge(assignEntry.dispatch_type)}
                    <p className="text-xs text-muted-foreground mt-1 max-w-[200px]">{assignEntry.dispatch_text}</p>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label>Buscar Cliente</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                  <Input placeholder="Nome, email ou empresa..." value={clientSearch} onChange={e => setClientSearch(e.target.value)} className="pl-9 rounded-xl" />
                </div>
              </div>

              <div className="space-y-2">
                <Label>Selecionar Cliente</Label>
                <ScrollArea className="h-[200px] border rounded-xl p-2">
                  {filteredClients.length === 0 ? (
                    <div className="text-center py-8 text-muted-foreground text-sm">{clientSearch ? 'Nenhum cliente encontrado' : 'Digite para buscar'}</div>
                  ) : (
                    <div className="space-y-1">
                      {filteredClients.slice(0, 20).map(client => (
                        <div
                          key={client.id}
                          onClick={() => setSelectedClient(client)}
                          className={`p-3 rounded-xl cursor-pointer transition-colors ${
                            selectedClient?.id === client.id ? 'bg-primary/10 border border-primary' : 'hover:bg-muted'
                          }`}
                        >
                          <div className="font-medium text-sm">{client.full_name || client.company_name || 'Sem nome'}</div>
                          <div className="text-xs text-muted-foreground">{client.email}</div>
                          {client.company_name && client.full_name && <div className="text-xs text-muted-foreground">{client.company_name}</div>}
                        </div>
                      ))}
                    </div>
                  )}
                </ScrollArea>
              </div>

              <div className="space-y-2">
                <Label>Prioridade</Label>
                <div className="flex gap-3">
                  <Button type="button" variant={assignPriority === 'medium' ? 'default' : 'outline'} onClick={() => setAssignPriority('medium')} className="flex-1 gap-2 rounded-xl">
                    <Clock className="h-4 w-4" />MÃ©dia
                  </Button>
                  <Button type="button" variant={assignPriority === 'urgent' ? 'destructive' : 'outline'} onClick={() => setAssignPriority('urgent')} className="flex-1 gap-2 rounded-xl">
                    <AlertTriangle className="h-4 w-4" />Urgente
                  </Button>
                </div>
              </div>

              <div className="rounded-xl bg-amber-500/5 border border-amber-500/20 p-3 flex items-center gap-3">
                <Calendar className="h-5 w-5 text-amber-600 flex-shrink-0" />
                <div>
                  <div className="font-medium text-sm">Prazo: 60 dias para cumprimento</div>
                  <div className="text-xs text-muted-foreground">O cliente serÃ¡ notificado automaticamente</div>
                </div>
              </div>
            </div>
          )}
          <DialogFooter>
            <Button variant="outline" onClick={() => setAssignDialogOpen(false)} className="rounded-xl">Cancelar</Button>
            <Button onClick={handleAssignClient} disabled={assigning || !selectedClient} className="gap-2 rounded-xl">
              {assigning ? <Loader2 className="h-4 w-4 animate-spin" /> : <UserPlus className="h-4 w-4" />}
              Vincular Cliente
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </AdminLayout>
  );
}
