import { useState, useEffect, useMemo, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from '@/components/ui/dialog';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { supabase } from '@/integrations/supabase/client';
import { toast } from 'sonner';
import { format, formatDistanceToNow } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import { cn } from '@/lib/utils';
import {
  User, Phone, Mail, Building2, DollarSign, Clock, Star,
  FileText, CreditCard, MessageSquare, Calendar as CalendarIcon, Paperclip,
  Upload, Loader2, ExternalLink, Plus, Edit, X, Check,
  MessageCircle, ArrowUpRight, Tag, Zap, AlertTriangle,
  CheckCircle, TrendingUp, Receipt, Trash2, UserCheck,
  Bell, Send, MapPin, Hash, Globe, Briefcase, Shield,
  ChevronRight, Activity, RefreshCw, Eye, Copy, Edit2,
  Package, BarChart3, Wallet, FileCheck, Lock
} from 'lucide-react';
import type { ClientWithProcess } from './ClientKanbanBoard';
import { PIPELINE_STAGES } from './ClientKanbanBoard';
import { usePricing } from '@/hooks/usePricing';

const MASTER_ADMIN_EMAIL = 'davillys@gmail.com';

interface ClientDetailSheetProps {
  client: ClientWithProcess | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onUpdate: () => void;
}

interface ClientNote { id: string; content: string; created_at: string; }
interface ClientAppointment { id: string; title: string; description: string | null; scheduled_at: string; completed: boolean; }
interface ClientDocument { id: string; name: string; file_url: string; created_at: string; file_size?: number | null; mime_type?: string | null; }
interface ClientInvoice { id: string; description: string; amount: number; status: string; due_date: string; payment_method?: string | null; pix_code?: string | null; }

const useServicePricingOptions = () => {
  const { pricing } = usePricing();
  return useMemo(() => [
    { id: 'registro_avista', label: 'Registro de Marca – À Vista', value: Math.round(pricing.avista.value), description: 'Pagamento único via PIX', details: `R$ ${pricing.avista.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} à vista` },
    { id: 'registro_boleto', label: 'Registro de Marca – Boleto', value: pricing.boleto.value, description: `${pricing.boleto.installments}x de R$ ${pricing.boleto.installmentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, details: `${pricing.boleto.installments}x R$ ${pricing.boleto.installmentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (boleto)` },
    { id: 'registro_cartao', label: 'Registro de Marca – Cartão', value: pricing.cartao.value, description: `${pricing.cartao.installments}x de R$ ${pricing.cartao.installmentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`, details: `${pricing.cartao.installments}x R$ ${pricing.cartao.installmentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (cartão)` },
    { id: 'exigencia_avista', label: 'Exigência/Publicação – À Vista', value: 1412, description: '1 Salário Mínimo', details: 'R$ 1.412,00 à vista (1 SM)' },
    { id: 'exigencia_parcelado', label: 'Exigência/Publicação – Parcelado', value: 2388, description: '6x de R$ 398,00', details: '6x R$ 398,00 (boleto ou cartão)' },
    { id: 'personalizado', label: 'Valor Personalizado', value: 0, description: 'Definir valor manualmente', details: 'Informe o valor e motivo' },
  ], [pricing]);
};

const SERVICE_TYPES = [
  { id: 'pedido_registro', label: 'Pedido de Registro', description: 'Solicitação inicial junto ao INPI', stage: 'protocolado', icon: FileText },
  { id: 'cumprimento_exigencia', label: 'Cumprimento de Exigência', description: 'Resposta a exigência formal do INPI', stage: '003', icon: FileCheck },
  { id: 'oposicao', label: 'Manifestação de Oposição', description: 'Defesa contra oposição de terceiros', stage: 'oposicao', icon: Shield },
  { id: 'recurso', label: 'Recurso Administrativo', description: 'Recurso contra indeferimento do INPI', stage: 'indeferimento', icon: TrendingUp },
  { id: 'renovacao', label: 'Renovação de Marca', description: 'Renovação do registro decenal', stage: 'renovacao', icon: RefreshCw },
  { id: 'notificacao', label: 'Notificação Extrajudicial', description: 'Cessação de uso indevido', stage: 'notificacao', icon: Bell },
  { id: 'deferimento', label: 'Deferimento', description: 'Pedido aprovado, aguardando concessão', stage: 'deferimento', icon: CheckCircle },
  { id: 'certificado', label: 'Certificado', description: 'Marca registrada e certificada', stage: 'certificados', icon: Star },
  { id: 'distrato', label: 'Distrato', description: 'Serviço cancelado ou encerrado', stage: 'distrato', icon: X },
];

const SERVICE_TYPE_TO_STAGE: Record<string, string> = {};
const STAGE_TO_SERVICE_TYPE: Record<string, string> = {};
SERVICE_TYPES.forEach(s => { SERVICE_TYPE_TO_STAGE[s.id] = s.stage; STAGE_TO_SERVICE_TYPE[s.stage] = s.id; });

const AVAILABLE_TAGS = ['VIP', 'Urgente', 'Novo', 'Renovação', 'Em Risco', 'Inativo', 'Prioritário', 'Pendente'];

const PRIORITY_CONFIG: Record<string, { label: string; color: string; dot: string }> = {
  high:   { label: 'Alta',  color: 'bg-red-500/15 text-red-400 border-red-500/30',    dot: 'bg-red-400' },
  medium: { label: 'Média', color: 'bg-amber-500/15 text-amber-400 border-amber-500/30', dot: 'bg-amber-400' },
  low:    { label: 'Baixa', color: 'bg-emerald-500/15 text-emerald-400 border-emerald-500/30', dot: 'bg-emerald-400' },
};

// ─── Empty State ─────────────────────────────────────────────────────────────
function EmptyState({ icon: Icon, title, description, action }: { icon: any; title: string; description: string; action?: React.ReactNode }) {
  return (
    <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="flex flex-col items-center justify-center py-14 gap-3">
      <div className="w-16 h-16 rounded-2xl bg-muted/50 border border-border flex items-center justify-center relative">
        <Icon className="h-7 w-7 text-muted-foreground/40" />
        <div className="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-primary/10 border border-primary/20 flex items-center justify-center">
          <Plus className="h-3 w-3 text-primary/60" />
        </div>
      </div>
      <div className="text-center">
        <p className="font-semibold text-sm">{title}</p>
        <p className="text-xs text-muted-foreground mt-0.5 max-w-[200px]">{description}</p>
      </div>
      {action}
    </motion.div>
  );
}

// ─── Info Row ────────────────────────────────────────────────────────────────
function InfoRow({ icon: Icon, label, value, mono, copyable, link }: { icon: any; label: string; value?: string | null; mono?: boolean; copyable?: boolean; link?: string }) {
  if (!value) return null;
  return (
    <div className="flex items-center gap-3 py-2.5 border-b border-border last:border-0 group">
      <div className="w-8 h-8 rounded-lg bg-muted/50 flex items-center justify-center flex-shrink-0">
        <Icon className="h-3.5 w-3.5 text-muted-foreground" />
      </div>
      <div className="flex-1 min-w-0">
        <p className="text-[10px] text-muted-foreground uppercase tracking-wider font-medium">{label}</p>
        <p className={cn('text-sm font-medium truncate', mono && 'font-mono')}>{value}</p>
      </div>
      <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
        {copyable && (
          <button className="w-6 h-6 rounded-md hover:bg-muted flex items-center justify-center" onClick={() => { navigator.clipboard.writeText(value); toast.success('Copiado!'); }}>
            <Copy className="h-3 w-3 text-muted-foreground" />
          </button>
        )}
        {link && (
          <a href={link} target="_blank" rel="noopener noreferrer" className="w-6 h-6 rounded-md hover:bg-muted flex items-center justify-center">
            <ExternalLink className="h-3 w-3 text-muted-foreground" />
          </a>
        )}
      </div>
    </div>
  );
}

// ─── File icon helper ─────────────────────────────────────────────────────────
function DocIcon({ mime }: { mime?: string | null }) {
  if (mime?.startsWith('image/')) return <Eye className="h-4 w-4 text-blue-400" />;
  if (mime?.includes('pdf')) return <FileText className="h-4 w-4 text-red-400" />;
  return <Paperclip className="h-4 w-4 text-muted-foreground" />;
}

function fmtBytes(b?: number | null) {
  if (!b) return '';
  if (b < 1024) return `${b}B`;
  if (b < 1048576) return `${(b/1024).toFixed(1)}KB`;
  return `${(b/1048576).toFixed(1)}MB`;
}

export function ClientDetailSheet({ client, open, onOpenChange, onUpdate }: ClientDetailSheetProps) {
  const SERVICE_PRICING_OPTIONS = useServicePricingOptions();

  // Data
  const [notes, setNotes] = useState<ClientNote[]>([]);
  const [appointments, setAppointments] = useState<ClientAppointment[]>([]);
  const [documents, setDocuments] = useState<ClientDocument[]>([]);
  const [invoices, setInvoices] = useState<ClientInvoice[]>([]);
  const [profileData, setProfileData] = useState<any>(null);
  const [adminUsersList, setAdminUsersList] = useState<{ id: string; full_name: string | null; email: string }[]>([]);

  // Loading states
  const [loading, setLoading] = useState(false);
  const [deleting, setDeleting] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [savingNote, setSavingNote] = useState(false);
  const [savingAppointment, setSavingAppointment] = useState(false);
  const [savingEdit, setSavingEdit] = useState(false);
  const [dragOver, setDragOver] = useState(false);

  // UI state
  const [newNote, setNewNote] = useState('');
  const [showNewAppointment, setShowNewAppointment] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [showPricingDialog, setShowPricingDialog] = useState(false);
  const [showMoveDialog, setShowMoveDialog] = useState(false);
  const [showNotificationDialog, setShowNotificationDialog] = useState(false);
  const [showEditDialog, setShowEditDialog] = useState(false);
  const [showTagsDialog, setShowTagsDialog] = useState(false);
  const [showAddProcessDialog, setShowAddProcessDialog] = useState(false);
  const [editingNoteId, setEditingNoteId] = useState<string | null>(null);
  const [editingNoteContent, setEditingNoteContent] = useState('');

  const fileInputRef = useRef<HTMLInputElement>(null);

  const [newAppointment, setNewAppointment] = useState({ title: '', description: '', date: new Date(), time: '10:00' });
  const [selectedPricing, setSelectedPricing] = useState('');
  const [customValue, setCustomValue] = useState(0);
  const [customValueReason, setCustomValueReason] = useState('');
  const [notificationTemplates, setNotificationTemplates] = useState<any[]>([]);
  const [notificationForm, setNotificationForm] = useState({ title: '', message: '', type: 'info', link: '/cliente/processos' });
  const [clientTags, setClientTags] = useState<string[]>([]);
  const [selectedServiceType, setSelectedServiceType] = useState('pedido_registro');

  const [editData, setEditData] = useState({ priority: '', origin: '', contract_value: 0, pipeline_stage: '' });
  const [editFormData, setEditFormData] = useState({
    full_name: '', email: '', phone: '', cpf: '', cnpj: '', company_name: '',
    address: '', neighborhood: '', city: '', state: '', zip_code: '',
    priority: 'medium', origin: 'site', brand_name: '', business_area: '', assigned_to: '',
  });
  const [newProcess, setNewProcess] = useState({ brand_name: '', process_number: '', pipeline_stage: 'protocolado', business_area: '' });

  useEffect(() => {
    if (client && open) {
      fetchClientData();
      setEditData({ priority: client.priority || 'medium', origin: client.origin || 'site', contract_value: client.contract_value || 0, pipeline_stage: client.pipeline_stage || 'protocolado' });
      const matchingServiceType = STAGE_TO_SERVICE_TYPE[client.pipeline_stage || 'protocolado'];
      setSelectedServiceType(matchingServiceType || 'pedido_registro');
      setEditFormData({
        full_name: client.full_name || '', email: client.email || '', phone: client.phone || '',
        cpf: '', cnpj: '', company_name: client.company_name || '',
        address: '', neighborhood: '', city: '', state: '', zip_code: '',
        priority: client.priority || 'medium', origin: client.origin || 'site',
        brand_name: client.brand_name || '', business_area: client.business_area || '', assigned_to: client.assigned_to || '',
      });
      const matchedOption = SERVICE_PRICING_OPTIONS.find(opt => opt.value === client.contract_value);
      if (matchedOption) setSelectedPricing(matchedOption.id);
      else if (client.contract_value && client.contract_value > 0) { setSelectedPricing('personalizado'); setCustomValue(client.contract_value); }
    }
  }, [client, open]);

  const fetchClientData = async () => {
    if (!client) return;
    setLoading(true);
    try {
      const [notesRes, appointmentsRes, docsRes, invoicesRes, profileRes, contractRes] = await Promise.all([
        supabase.from('client_notes').select('*').eq('user_id', client.id).order('created_at', { ascending: false }),
        supabase.from('client_appointments').select('*').eq('user_id', client.id).order('scheduled_at', { ascending: true }),
        supabase.from('documents').select('*').eq('user_id', client.id).order('created_at', { ascending: false }),
        supabase.from('invoices').select('*').eq('user_id', client.id).order('due_date', { ascending: false }),
        supabase.from('profiles').select('cpf, cnpj, company_name, address, neighborhood, city, state, zip_code, assigned_to, contract_value').eq('id', client.id).maybeSingle(),
        supabase.from('contracts').select('contract_value, payment_method, signature_status').eq('user_id', client.id).order('created_at', { ascending: false }).limit(1),
      ]);
      setNotes(notesRes.data || []);
      setAppointments(appointmentsRes.data || []);
      setDocuments(docsRes.data || []);
      setInvoices(invoicesRes.data || []);
      setProfileData(profileRes.data);
      if (contractRes.data && contractRes.data.length > 0) {
        const contract = contractRes.data[0];
        if (contract.contract_value && contract.contract_value > 0) {
          setEditData(prev => ({ ...prev, contract_value: Number(contract.contract_value) }));
          if (profileRes.data && Number((profileRes.data as any).contract_value || 0) !== Number(contract.contract_value)) {
            await supabase.from('profiles').update({ contract_value: contract.contract_value }).eq('id', client.id);
          }
        }
      }
      if (profileRes.data) {
        setEditFormData(prev => ({
          ...prev,
          cpf: (profileRes.data as any).cpf || '',
          cnpj: (profileRes.data as any).cnpj || '',
          company_name: (profileRes.data as any).company_name || prev.company_name || '',
          address: (profileRes.data as any).address || '',
          neighborhood: (profileRes.data as any).neighborhood || '',
          city: (profileRes.data as any).city || '',
          state: (profileRes.data as any).state || '',
          zip_code: (profileRes.data as any).zip_code || '',
          assigned_to: (profileRes.data as any).assigned_to || '',
        }));
      }
      const { data: roles } = await supabase.from('user_roles').select('user_id').eq('role', 'admin');
      if (roles && roles.length > 0) {
        const { data: adminProfiles } = await supabase.from('profiles').select('id, full_name, email').in('id', roles.map(r => r.user_id));
        if (adminProfiles) setAdminUsersList(adminProfiles);
      }
    } catch (error) { console.error('Error fetching client data:', error); }
    finally { setLoading(false); }
  };

  // ─── Note CRUD ────────────────────────────────────────────────────────────
  const handleAddNote = async () => {
    if (!newNote.trim() || !client) return;
    setSavingNote(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      const { error } = await supabase.from('client_notes').insert({ user_id: client.id, admin_id: user?.id, content: newNote });
      if (error) throw error;
      toast.success('Nota adicionada');
      setNewNote('');
      await fetchClientData();
    } catch { toast.error('Erro ao adicionar nota'); }
    finally { setSavingNote(false); }
  };

  const handleDeleteNote = async (id: string) => {
    const { error } = await supabase.from('client_notes').delete().eq('id', id);
    if (error) { toast.error('Erro ao excluir nota'); return; }
    toast.success('Nota excluída');
    await fetchClientData();
  };

  const handleSaveEditNote = async (id: string) => {
    if (!editingNoteContent.trim()) return;
    const { error } = await supabase.from('client_notes').update({ content: editingNoteContent.trim() }).eq('id', id);
    if (error) { toast.error('Erro ao editar nota'); return; }
    setEditingNoteId(null);
    toast.success('Nota atualizada');
    await fetchClientData();
  };

  // ─── Appointment CRUD ─────────────────────────────────────────────────────
  const handleCreateAppointment = async () => {
    if (!newAppointment.title.trim() || !client) return;
    setSavingAppointment(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      const scheduledAt = new Date(newAppointment.date);
      const [h, m] = newAppointment.time.split(':');
      scheduledAt.setHours(parseInt(h), parseInt(m));
      const { error } = await supabase.from('client_appointments').insert({ user_id: client.id, admin_id: user?.id, title: newAppointment.title, description: newAppointment.description, scheduled_at: scheduledAt.toISOString() });
      if (error) throw error;
      toast.success('Agendamento criado!');
      setShowNewAppointment(false);
      setNewAppointment({ title: '', description: '', date: new Date(), time: '10:00' });
      await fetchClientData();
    } catch { toast.error('Erro ao criar agendamento'); }
    finally { setSavingAppointment(false); }
  };

  const handleToggleAppointment = async (apt: ClientAppointment) => {
    const { error } = await supabase.from('client_appointments').update({ completed: !apt.completed }).eq('id', apt.id);
    if (error) { toast.error('Erro ao atualizar agendamento'); return; }
    toast.success(apt.completed ? 'Reaberto' : 'Concluído!');
    await fetchClientData();
  };

  const handleDeleteAppointment = async (id: string) => {
    const { error } = await supabase.from('client_appointments').delete().eq('id', id);
    if (error) { toast.error('Erro ao excluir agendamento'); return; }
    toast.success('Agendamento excluído');
    await fetchClientData();
  };

  // ─── File Upload ──────────────────────────────────────────────────────────
  const handleFileUpload = async (files: FileList | null) => {
    if (!files || !client) return;
    setUploading(true);
    let uploaded = 0;
    try {
      const { data: { user } } = await supabase.auth.getUser();
      for (const file of Array.from(files)) {
        const fileName = `clients/${client.id}/${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from('documents').upload(fileName, file, { upsert: false });
        if (uploadError) { toast.error(`Erro: ${uploadError.message}`); continue; }
        const { data: { publicUrl } } = supabase.storage.from('documents').getPublicUrl(fileName);
        const { error: dbError } = await supabase.from('documents').insert({ user_id: client.id, name: file.name, file_url: publicUrl, document_type: 'anexo', uploaded_by: user?.id || 'admin', file_size: file.size, mime_type: file.type });
        if (!dbError) uploaded++;
      }
      if (uploaded > 0) { toast.success(`${uploaded} arquivo(s) enviado(s)`); await fetchClientData(); }
    } finally { setUploading(false); }
  };

  const handleDeleteDocument = async (doc: ClientDocument) => {
    const urlParts = doc.file_url.split('/storage/v1/object/public/documents/');
    if (urlParts[1]) await supabase.storage.from('documents').remove([urlParts[1]]);
    const { error } = await supabase.from('documents').delete().eq('id', doc.id);
    if (error) { toast.error('Erro ao excluir arquivo'); return; }
    toast.success('Arquivo excluído');
    await fetchClientData();
  };

  // ─── Save Profile ─────────────────────────────────────────────────────────
  const handleSaveFullEdit = async () => {
    if (!client) return;
    setSavingEdit(true);
    try {
      const { error: profileError } = await supabase.from('profiles').update({
        full_name: editFormData.full_name, email: editFormData.email, phone: editFormData.phone,
        cpf: editFormData.cpf || null, cnpj: editFormData.cnpj || null,
        cpf_cnpj: editFormData.cpf || editFormData.cnpj || null,
        company_name: editFormData.company_name, address: editFormData.address,
        neighborhood: editFormData.neighborhood, city: editFormData.city,
        state: editFormData.state, zip_code: editFormData.zip_code,
        priority: editFormData.priority, origin: editFormData.origin,
        assigned_to: editFormData.assigned_to || null,
      }).eq('id', client.id);
      if (profileError) throw profileError;
      if (client.process_id && (editFormData.brand_name || editFormData.business_area)) {
        await supabase.from('brand_processes').update({ brand_name: editFormData.brand_name, business_area: editFormData.business_area || null }).eq('id', client.process_id);
      }
      toast.success('Dados do cliente atualizados!');
      setShowEditDialog(false);
      onUpdate();
      await fetchClientData();
    } catch (error: any) { toast.error(`Erro: ${error?.message}`); }
    finally { setSavingEdit(false); }
  };

  const handleSaveQuickChanges = async () => {
    if (!client) return;
    try {
      await supabase.from('profiles').update({ priority: editData.priority, origin: editData.origin, contract_value: editData.contract_value }).eq('id', client.id);
      if (client.process_id) await supabase.from('brand_processes').update({ pipeline_stage: editData.pipeline_stage }).eq('id', client.process_id);
      toast.success('Alterações salvas');
      onUpdate();
    } catch { toast.error('Erro ao salvar'); }
  };

  // ─── Delete client ────────────────────────────────────────────────────────
  const handleDeleteClient = async () => {
    if (!client || !client.id) return;
    if (client.email === MASTER_ADMIN_EMAIL) { toast.error('Administrador master não pode ser excluído.'); return; }
    setDeleting(true);
    try {
      await Promise.all([
        supabase.from('client_notes').delete().eq('user_id', client.id),
        supabase.from('client_activities').delete().eq('user_id', client.id),
        supabase.from('client_appointments').delete().eq('user_id', client.id),
        supabase.from('notifications').delete().eq('user_id', client.id),
        supabase.from('chat_messages').delete().eq('user_id', client.id),
        supabase.from('documents').delete().eq('user_id', client.id),
        supabase.from('invoices').delete().eq('user_id', client.id),
        supabase.from('contracts').delete().eq('user_id', client.id),
        supabase.from('brand_processes').delete().eq('user_id', client.id),
        supabase.from('login_history').delete().eq('user_id', client.id),
        supabase.from('user_roles').delete().eq('user_id', client.id),
      ]);
      const { error } = await supabase.from('profiles').delete().eq('id', client.id);
      if (error) throw error;
      toast.success('Cliente excluído com sucesso');
      setShowDeleteConfirm(false);
      onOpenChange(false);
      onUpdate();
    } catch (error: any) { toast.error(`Erro ao excluir: ${error?.message}`); }
    finally { setDeleting(false); }
  };

  // ─── Move funnel ──────────────────────────────────────────────────────────
  const handleMoveFunnel = async (targetFunnel: 'comercial' | 'juridico') => {
    if (!client) return;
    const currentFunnel = client.client_funnel_type || 'juridico';
    if (currentFunnel === targetFunnel) { toast.info('Cliente já está neste funil'); setShowMoveDialog(false); return; }
    try {
      if (targetFunnel === 'juridico') {
        const { data: contracts } = await supabase.from('contracts').select('id, signature_status').eq('user_id', client.id).eq('signature_status', 'signed').limit(1);
        if (!contracts || contracts.length === 0) { toast.error('Cliente precisa ter um contrato assinado para ir ao funil jurídico'); return; }
        await supabase.from('profiles').update({ client_funnel_type: 'juridico' }).eq('id', client.id);
        if (client.process_id) await supabase.from('brand_processes').update({ pipeline_stage: 'protocolado' }).eq('id', client.process_id);
      } else {
        await supabase.from('profiles').update({ client_funnel_type: 'comercial' }).eq('id', client.id);
        if (client.process_id) await supabase.from('brand_processes').update({ pipeline_stage: 'assinou_contrato' }).eq('id', client.process_id);
      }
      const { data: { user } } = await supabase.auth.getUser();
      await supabase.from('client_activities').insert({ user_id: client.id, admin_id: user?.id, activity_type: 'funnel_move', description: `Movido para funil ${targetFunnel}` });
      toast.success(`Cliente movido para o funil ${targetFunnel === 'comercial' ? 'Comercial' : 'Jurídico'}!`);
      setShowMoveDialog(false);
      onUpdate();
      onOpenChange(false);
    } catch (error: any) { toast.error(`Erro ao mover: ${error?.message}`); }
  };

  // ─── Create process ───────────────────────────────────────────────────────
  const handleCreateProcess = async () => {
    if (!client || !newProcess.brand_name.trim()) { toast.error('Nome da marca é obrigatório'); return; }
    try {
      const { error } = await supabase.from('brand_processes').insert({ user_id: client.id, brand_name: newProcess.brand_name, process_number: newProcess.process_number || null, pipeline_stage: newProcess.pipeline_stage, business_area: newProcess.business_area || null, status: 'em_andamento' });
      if (error) throw error;
      toast.success('Processo criado!');
      setShowAddProcessDialog(false);
      setNewProcess({ brand_name: '', process_number: '', pipeline_stage: 'protocolado', business_area: '' });
      onUpdate();
    } catch (error: any) { toast.error(`Erro: ${error?.message}`); }
  };

  const handleQuickAction = async (actionId: string) => {
    switch (actionId) {
      case 'chat':
        if (client) window.dispatchEvent(new CustomEvent('open-admin-chat', { detail: { clientId: client.id } }));
        break;
      case 'move': setShowMoveDialog(true); break;
      case 'email':
        if (client?.email) window.location.href = `/admin/emails?compose=true&to=${encodeURIComponent(client.email)}&name=${encodeURIComponent(client.full_name || '')}`;
        else toast.error('Cliente sem e-mail cadastrado');
        break;
      case 'notification':
        if (client) {
          const { data: tpls } = await supabase.from('notification_templates' as any).select('id, name, title, message, type').eq('is_active', true);
          setNotificationTemplates((tpls as any) || []);
          setNotificationForm({ title: '', message: '', type: 'info', link: '/cliente/processos' });
          setShowNotificationDialog(true);
        }
        break;
      case 'excluir': setShowDeleteConfirm(true); break;
    }
  };

  if (!client) return null;

  const currentStage = PIPELINE_STAGES.find(s => s.id === (editData.pipeline_stage || client.pipeline_stage || 'protocolado'));
  const priCfg = PRIORITY_CONFIG[client.priority || 'medium'] || PRIORITY_CONFIG.medium;
  const initials = (client.full_name || 'C').split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
  const isSigned = invoices.length > 0 || documents.length > 0;
  const contractValue = editData.contract_value || client.contract_value || 0;

  const QUICK_ACTIONS = [
    { id: 'chat', label: 'Chat', icon: MessageCircle, cls: 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700' },
    { id: 'move', label: 'Mover', icon: ArrowUpRight, cls: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/60' },
    { id: 'email', label: 'Email', icon: Mail, cls: 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 hover:bg-amber-200' },
    { id: 'notification', label: 'Notificar', icon: Bell, cls: 'bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-200' },
    { id: 'excluir', label: 'Excluir', icon: Trash2, cls: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 hover:bg-red-200' },
  ];

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="w-full sm:max-w-2xl p-0 overflow-hidden flex flex-col">
        {/* ──────────────────────────────── HEADER ────────────────────────── */}
        <div className={cn('relative overflow-hidden flex-shrink-0', currentStage?.color || 'bg-gradient-to-r from-blue-600 to-blue-700')}>
          {/* Background pattern */}
          <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle at 20% 50%, white 1px, transparent 1px), radial-gradient(circle at 80% 80%, white 1px, transparent 1px)', backgroundSize: '30px 30px' }} />

          <div className="relative p-5">
            <SheetHeader className="space-y-0">
              {/* Top row */}
              <div className="flex items-start gap-3.5">
                {/* Avatar */}
                <motion.div
                  className="w-14 h-14 rounded-2xl bg-white/25 backdrop-blur-sm border border-white/30 flex items-center justify-center text-white text-xl font-bold shadow-lg flex-shrink-0"
                  initial={{ scale: 0, rotate: -10 }}
                  animate={{ scale: 1, rotate: 0 }}
                  transition={{ type: 'spring', stiffness: 200, delay: 0.05 }}
                >
                  {initials}
                </motion.div>

                {/* Name / info */}
                <div className="flex-1 min-w-0">
                  <SheetTitle className="text-white text-lg font-bold flex items-center gap-2 flex-wrap">
                    {client.full_name || 'Sem nome'}
                    <Badge className={cn('border text-[10px] font-bold px-2 py-0.5 ml-1', priCfg.color)}>
                      <div className={cn('w-1.5 h-1.5 rounded-full mr-1', priCfg.dot)} />
                      {priCfg.label}
                    </Badge>
                  </SheetTitle>
                  <p className="text-white/60 text-xs mt-0.5 font-mono">ID: {client.id.slice(0, 8)}…</p>

                  <div className="flex flex-wrap gap-1.5 mt-2">
                    <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/20 text-white text-xs font-medium">
                      <Globe className="h-3 w-3" />
                      {client.origin === 'whatsapp' ? 'WhatsApp' : client.origin === 'indicacao' ? 'Indicação' : 'Site'}
                    </span>
                    {currentStage && (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/20 text-white text-xs font-medium">
                        <MapPin className="h-3 w-3" />
                        {currentStage.label}
                      </span>
                    )}
                    {client.brand_name && (
                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/20 text-white text-xs font-medium">
                        <Tag className="h-3 w-3" />
                        {client.brand_name}
                      </span>
                    )}
                  </div>
                </div>

                {/* Action buttons */}
                <div className="flex gap-1.5 flex-shrink-0">
                  <Dialog open={showDeleteConfirm} onOpenChange={setShowDeleteConfirm}>
                    <DialogTrigger asChild>
                      <button className="w-9 h-9 rounded-xl bg-red-500/80 hover:bg-red-500 border border-red-400/40 flex items-center justify-center transition-colors">
                        <Trash2 className="h-4 w-4 text-white" />
                      </button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader><DialogTitle className="flex items-center gap-2 text-destructive"><AlertTriangle className="h-5 w-5" />Excluir Cliente</DialogTitle></DialogHeader>
                      <div className="py-4 space-y-4">
                        <p className="text-sm text-muted-foreground">Tem certeza que deseja excluir <strong>{client.full_name}</strong>? Esta ação é <strong>irreversível</strong>.</p>
                        <div className="bg-destructive/10 border border-destructive/20 rounded-xl p-3 text-xs text-muted-foreground space-y-1">
                          <p className="font-semibold text-destructive mb-2">Serão excluídos permanentemente:</p>
                          {['Todos os processos de marca', 'Todos os contratos', 'Todas as faturas', 'Todos os documentos e notas', 'Histórico de acesso'].map(item => (
                            <p key={item}>• {item}</p>
                          ))}
                        </div>
                      </div>
                      <DialogFooter>
                        <Button variant="outline" onClick={() => setShowDeleteConfirm(false)}>Cancelar</Button>
                        <Button variant="destructive" onClick={handleDeleteClient} disabled={deleting}>
                          {deleting ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : <Trash2 className="h-4 w-4 mr-2" />}
                          Excluir
                        </Button>
                      </DialogFooter>
                    </DialogContent>
                  </Dialog>

                  <button
                    className="w-9 h-9 rounded-xl bg-white/20 hover:bg-white/30 border border-white/30 flex items-center justify-center transition-colors"
                    onClick={() => setShowEditDialog(true)}
                  >
                    <Edit2 className="h-4 w-4 text-white" />
                  </button>
                </div>
              </div>

              {/* Responsible admin */}
              <div className="mt-3">
                <Popover>
                  <PopoverTrigger asChild>
                    <button className="flex items-center gap-2 bg-white/15 hover:bg-white/25 border border-white/20 rounded-xl px-3 py-2 transition-colors">
                      <div className="w-6 h-6 rounded-full bg-white/30 flex items-center justify-center">
                        <UserCheck className="h-3.5 w-3.5 text-white" />
                      </div>
                      <div className="text-left">
                        <p className="text-[10px] text-white/60 leading-none">Responsável</p>
                        <p className="text-xs font-bold text-white leading-tight">
                          {client.assigned_to_name || client.created_by_name || (client.origin === 'site' ? 'Site' : 'Não atribuído')}
                        </p>
                      </div>
                      <ChevronRight className="h-3.5 w-3.5 text-white/50 ml-1" />
                    </button>
                  </PopoverTrigger>
                  <PopoverContent className="w-64" align="start">
                    <div className="space-y-3">
                      <div>
                        <h4 className="font-semibold text-sm">Atribuir Cliente</h4>
                        <p className="text-xs text-muted-foreground">Selecione o administrador responsável</p>
                      </div>
                      <Select value={editFormData.assigned_to} onValueChange={async (value) => {
                        const newAssignedTo = value === 'none' ? null : value;
                        setEditFormData(prev => ({ ...prev, assigned_to: newAssignedTo || '' }));
                        try {
                          await supabase.from('profiles').update({ assigned_to: newAssignedTo }).eq('id', client.id);
                          toast.success('Atribuído com sucesso!');
                          onUpdate();
                        } catch { toast.error('Erro ao atribuir'); }
                      }}>
                        <SelectTrigger><SelectValue placeholder="Selecionar admin…" /></SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">Nenhum</SelectItem>
                          {adminUsersList.map(a => <SelectItem key={a.id} value={a.id}>{a.full_name || a.email}</SelectItem>)}
                        </SelectContent>
                      </Select>
                    </div>
                  </PopoverContent>
                </Popover>
              </div>

              {/* Quick Actions */}
              <div className="mt-3 pt-3 border-t border-white/15">
                <p className="text-[10px] text-white/50 font-semibold uppercase tracking-wider mb-2 flex items-center gap-1">
                  <Zap className="h-3 w-3" /> Ações Rápidas
                </p>
                <div className="flex flex-wrap gap-2">
                  {QUICK_ACTIONS.map(action => (
                    <motion.button
                      key={action.id}
                      whileHover={{ scale: 1.05 }}
                      whileTap={{ scale: 0.95 }}
                      className={cn('px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1.5 transition-colors', action.cls)}
                      onClick={() => handleQuickAction(action.id)}
                    >
                      <action.icon className="h-3.5 w-3.5" />
                      {action.label}
                    </motion.button>
                  ))}
                </div>
              </div>
            </SheetHeader>
          </div>
        </div>

        {/* ──────────────────────────────── TABS ──────────────────────────── */}
        <div className="flex-1 overflow-hidden flex flex-col">
          <Tabs defaultValue="overview" className="flex-1 overflow-hidden flex flex-col">
            {/* Tab bar */}
            <div className="border-b border-border flex-shrink-0 px-1">
              <TabsList className="h-auto bg-transparent p-0 gap-0 w-full justify-start overflow-x-auto flex-nowrap">
                {[
                  { value: 'overview', label: 'Geral', icon: User },
                  { value: 'contacts', label: 'Contatos', icon: Phone },
                  { value: 'services', label: 'Serviços', icon: Package },
                  { value: 'appointments', label: 'Agenda', icon: CalendarIcon },
                  { value: 'attachments', label: 'Anexos', icon: Paperclip },
                  { value: 'financial', label: 'Financeiro', icon: Wallet },
                ].map(tab => (
                  <TabsTrigger
                    key={tab.value}
                    value={tab.value}
                    className="relative h-10 rounded-none px-3.5 text-xs font-medium text-muted-foreground border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:text-foreground data-[state=active]:bg-transparent bg-transparent hover:text-foreground transition-colors gap-1.5 whitespace-nowrap"
                  >
                    <tab.icon className="h-3.5 w-3.5" />
                    {tab.label}
                  </TabsTrigger>
                ))}
              </TabsList>
            </div>

            <ScrollArea className="flex-1">
              <div className="p-5 space-y-5">

                {/* ─── GERAL TAB ─────────────────────────────────────────── */}
                <TabsContent value="overview" className="mt-0 space-y-5">
                  {/* KPI Cards */}
                  <div className="grid grid-cols-3 gap-3">
                    <motion.div
                      className="rounded-2xl border border-border bg-emerald-500/5 border-emerald-500/20 p-4 cursor-pointer group"
                      whileHover={{ scale: 1.02 }}
                      onClick={() => setShowPricingDialog(true)}
                    >
                      <div className="flex items-center gap-1.5 mb-2">
                        <DollarSign className="h-3.5 w-3.5 text-emerald-500" />
                        <span className="text-[10px] text-muted-foreground uppercase tracking-wider font-semibold">Valor</span>
                        <Edit2 className="h-3 w-3 text-muted-foreground ml-auto opacity-0 group-hover:opacity-100" />
                      </div>
                      <p className="font-bold text-emerald-500 text-lg leading-none">
                        {contractValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                      </p>
                      {selectedPricing && selectedPricing !== 'personalizado' && (
                        <p className="text-[10px] text-muted-foreground mt-1 truncate">
                          {SERVICE_PRICING_OPTIONS.find(o => o.id === selectedPricing)?.details}
                        </p>
                      )}
                    </motion.div>

                    <div className="rounded-2xl border border-border bg-muted/30 p-4">
                      <div className="flex items-center gap-1.5 mb-2">
                        <Clock className="h-3.5 w-3.5 text-muted-foreground" />
                        <span className="text-[10px] text-muted-foreground uppercase tracking-wider font-semibold">Último Contato</span>
                      </div>
                      <p className="font-semibold text-sm">
                        {notes.length > 0
                          ? formatDistanceToNow(new Date(notes[0].created_at), { addSuffix: true, locale: ptBR })
                          : 'Nunca'}
                      </p>
                    </div>

                    <div className="rounded-2xl border border-border bg-amber-500/5 border-amber-500/20 p-4">
                      <div className="flex items-center gap-1.5 mb-2">
                        <Star className="h-3.5 w-3.5 text-amber-500" />
                        <span className="text-[10px] text-muted-foreground uppercase tracking-wider font-semibold">Prioridade</span>
                      </div>
                      <Badge className={cn('border text-xs', priCfg.color)}>
                        <div className={cn('w-1.5 h-1.5 rounded-full mr-1.5', priCfg.dot)} />
                        {priCfg.label}
                      </Badge>
                    </div>
                  </div>

                  {/* Tags */}
                  <div className="rounded-2xl border border-border bg-card p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <Tag className="h-4 w-4 text-muted-foreground" />
                        <span className="text-sm font-semibold">Tags</span>
                      </div>
                      <Dialog open={showTagsDialog} onOpenChange={setShowTagsDialog}>
                        <DialogTrigger asChild>
                          <Button variant="outline" size="sm" className="h-7 text-xs"><Plus className="h-3 w-3 mr-1" />Gerenciar</Button>
                        </DialogTrigger>
                        <DialogContent>
                          <DialogHeader><DialogTitle className="flex items-center gap-2"><Tag className="h-5 w-5" />Gerenciar Tags</DialogTitle></DialogHeader>
                          <div className="py-4">
                            <div className="grid grid-cols-3 gap-2">
                              {AVAILABLE_TAGS.map(tag => (
                                <Button key={tag} variant={clientTags.includes(tag) ? 'default' : 'outline'} size="sm" onClick={() => setClientTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag])}>
                                  {clientTags.includes(tag) && <Check className="h-3 w-3 mr-1" />}{tag}
                                </Button>
                              ))}
                            </div>
                          </div>
                          <DialogFooter><Button onClick={() => setShowTagsDialog(false)}>Concluído</Button></DialogFooter>
                        </DialogContent>
                      </Dialog>
                    </div>
                    {clientTags.length > 0 ? (
                      <div className="flex flex-wrap gap-1.5">
                        {clientTags.map(tag => (
                          <Badge key={tag} variant="secondary" className="cursor-pointer gap-1" onClick={() => setClientTags(prev => prev.filter(t => t !== tag))}>
                            {tag}<X className="h-2.5 w-2.5" />
                          </Badge>
                        ))}
                      </div>
                    ) : (
                      <p className="text-xs text-muted-foreground">Nenhuma tag. Clique em "Gerenciar" para adicionar.</p>
                    )}
                  </div>

                  {/* Notes */}
                  <div className="rounded-2xl border border-border bg-card p-4 space-y-3">
                    <div className="flex items-center gap-2">
                      <MessageSquare className="h-4 w-4 text-muted-foreground" />
                      <span className="text-sm font-semibold">Notas Internas</span>
                      {notes.length > 0 && <Badge variant="secondary" className="text-[10px] h-4 px-1.5">{notes.length}</Badge>}
                    </div>

                    <div className="flex gap-2">
                      <Textarea
                        placeholder="Adicionar uma nota interna..."
                        value={newNote}
                        onChange={(e) => setNewNote(e.target.value)}
                        onKeyDown={(e) => { if (e.key === 'Enter' && e.ctrlKey) handleAddNote(); }}
                        rows={2}
                        className="resize-none flex-1 text-sm"
                      />
                      <Button size="sm" className="self-end h-9 w-9 p-0" onClick={handleAddNote} disabled={savingNote || !newNote.trim()}>
                        {savingNote ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}
                      </Button>
                    </div>

                    {notes.length > 0 && (
                      <div className="space-y-2 max-h-56 overflow-y-auto pr-1">
                        <AnimatePresence>
                          {notes.map(note => (
                            <motion.div
                              key={note.id}
                              initial={{ opacity: 0, y: -6 }}
                              animate={{ opacity: 1, y: 0 }}
                              exit={{ opacity: 0, x: -20 }}
                              className="relative rounded-xl border border-amber-500/20 bg-amber-500/5 p-3 group overflow-hidden"
                            >
                              <div className="absolute top-0 left-0 w-0.5 h-full bg-amber-400/60 rounded-l-xl" />
                              <div className="pl-2">
                                {editingNoteId === note.id ? (
                                  <div className="space-y-2">
                                    <Textarea value={editingNoteContent} onChange={(e) => setEditingNoteContent(e.target.value)} rows={2} className="resize-none text-xs" autoFocus />
                                    <div className="flex gap-2 justify-end">
                                      <Button variant="ghost" size="sm" className="h-6 text-xs" onClick={() => setEditingNoteId(null)}>Cancelar</Button>
                                      <Button size="sm" className="h-6 text-xs" onClick={() => handleSaveEditNote(note.id)}>Salvar</Button>
                                    </div>
                                  </div>
                                ) : (
                                  <>
                                    <p className="text-sm leading-relaxed">{note.content}</p>
                                    <div className="flex items-center justify-between mt-1.5">
                                      <p className="text-[10px] text-muted-foreground">
                                        {formatDistanceToNow(new Date(note.created_at), { addSuffix: true, locale: ptBR })}
                                      </p>
                                      <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button className="w-5 h-5 rounded hover:bg-muted flex items-center justify-center" onClick={() => { setEditingNoteId(note.id); setEditingNoteContent(note.content); }}>
                                          <Edit2 className="h-2.5 w-2.5 text-muted-foreground" />
                                        </button>
                                        <button className="w-5 h-5 rounded hover:bg-destructive/10 flex items-center justify-center" onClick={() => handleDeleteNote(note.id)}>
                                          <Trash2 className="h-2.5 w-2.5 text-muted-foreground hover:text-destructive" />
                                        </button>
                                      </div>
                                    </div>
                                  </>
                                )}
                              </div>
                            </motion.div>
                          ))}
                        </AnimatePresence>
                      </div>
                    )}
                  </div>
                </TabsContent>

                {/* ─── CONTACTS TAB ──────────────────────────────────────── */}
                <TabsContent value="contacts" className="mt-0 space-y-4">
                  {/* Personal */}
                  <div className="rounded-2xl border border-border bg-card p-4">
                    <div className="flex items-center gap-2 mb-3 pb-2 border-b border-border">
                      <User className="h-4 w-4 text-primary" />
                      <span className="text-sm font-semibold">Dados Pessoais</span>
                    </div>
                    <InfoRow icon={User} label="Nome Completo" value={client.full_name} copyable />
                    <InfoRow icon={Hash} label="CPF" value={profileData?.cpf || client.cpf_cnpj} mono copyable />
                    <InfoRow icon={Hash} label="CNPJ" value={profileData?.cnpj} mono copyable />
                    <InfoRow icon={Mail} label="E-mail" value={client.email} copyable link={`mailto:${client.email}`} />
                    <InfoRow icon={Phone} label="Telefone" value={client.phone} copyable link={`https://wa.me/55${client.phone?.replace(/\D/g,'')}`} />
                    <InfoRow icon={Building2} label="Empresa" value={client.company_name || profileData?.company_name} />
                  </div>

                  {/* Address */}
                  {(profileData?.address || profileData?.city) && (
                    <div className="rounded-2xl border border-border bg-card p-4">
                      <div className="flex items-center gap-2 mb-3 pb-2 border-b border-border">
                        <MapPin className="h-4 w-4 text-primary" />
                        <span className="text-sm font-semibold">Endereço</span>
                      </div>
                      <InfoRow icon={MapPin} label="Logradouro" value={[profileData.address, profileData.neighborhood].filter(Boolean).join(' – ')} />
                      <InfoRow icon={Globe} label="Cidade / Estado" value={[profileData.city, profileData.state].filter(Boolean).join(' – ')} />
                      <InfoRow icon={Hash} label="CEP" value={profileData.zip_code} mono copyable />
                    </div>
                  )}

                  {/* Brand info */}
                  {client.brand_name && (
                    <div className="rounded-2xl border border-border bg-card p-4">
                      <div className="flex items-center gap-2 mb-3 pb-2 border-b border-border">
                        <Tag className="h-4 w-4 text-primary" />
                        <span className="text-sm font-semibold">Dados da Marca</span>
                      </div>
                      <InfoRow icon={Tag} label="Nome da Marca" value={client.brand_name} copyable />
                      <InfoRow icon={Briefcase} label="Ramo de Atividade" value={client.business_area} />
                      {client.process_number && <InfoRow icon={Hash} label="Protocolo INPI" value={client.process_number} mono copyable />}
                    </div>
                  )}
                </TabsContent>

                {/* ─── SERVICES TAB ──────────────────────────────────────── */}
                <TabsContent value="services" className="mt-0 space-y-4">
                  {client.process_id ? (
                    <div className="space-y-4">
                      {/* Pipeline stage selector */}
                      <div className="rounded-2xl border border-border bg-card p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-2">
                            <Activity className="h-4 w-4 text-primary" />
                            <span className="text-sm font-semibold">Fase do Pipeline</span>
                          </div>
                          <Select value={editData.pipeline_stage} onValueChange={async (v) => {
                            setEditData(prev => ({ ...prev, pipeline_stage: v }));
                            const matching = STAGE_TO_SERVICE_TYPE[v];
                            if (matching) setSelectedServiceType(matching);
                            if (client.process_id) {
                              await supabase.from('brand_processes').update({ pipeline_stage: v }).eq('id', client.process_id);
                              toast.success('Pipeline atualizado!');
                              onUpdate();
                            }
                          }}>
                            <SelectTrigger className="h-8 w-auto text-xs border-0 bg-muted/50 rounded-lg">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              {PIPELINE_STAGES.map(s => <SelectItem key={s.id} value={s.id}>{s.label}</SelectItem>)}
                            </SelectContent>
                          </Select>
                        </div>
                        {currentStage && (
                          <div className={cn('rounded-xl p-3 text-sm font-medium flex items-center gap-2', currentStage.color)}>
                            <div className="w-2 h-2 rounded-full bg-current opacity-80" />
                            {currentStage.label}
                          </div>
                        )}
                      </div>

                      {/* Service types */}
                      <div className="rounded-2xl border border-border bg-card p-4">
                        <div className="flex items-center gap-2 mb-3 pb-2 border-b border-border">
                          <Package className="h-4 w-4 text-primary" />
                          <span className="text-sm font-semibold">Tipo de Serviço</span>
                        </div>
                        <div className="space-y-2">
                          {SERVICE_TYPES.map(svc => {
                            const Icon = svc.icon;
                            const isSelected = selectedServiceType === svc.id;
                            return (
                              <motion.button
                                key={svc.id}
                                whileTap={{ scale: 0.98 }}
                                className={cn(
                                  'w-full flex items-center gap-3 p-3 rounded-xl border text-left transition-all',
                                  isSelected ? 'border-primary/40 bg-primary/5' : 'border-border hover:border-primary/20 hover:bg-muted/30'
                                )}
                                onClick={async () => {
                                  setSelectedServiceType(svc.id);
                                  const newStage = SERVICE_TYPE_TO_STAGE[svc.id];
                                  setEditData(prev => ({ ...prev, pipeline_stage: newStage }));
                                  if (client.process_id) {
                                    await supabase.from('brand_processes').update({ pipeline_stage: newStage }).eq('id', client.process_id);
                                    toast.success(`Serviço: ${svc.label}`);
                                    onUpdate();
                                  }
                                }}
                              >
                                <div className={cn('w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0', isSelected ? 'bg-primary/20' : 'bg-muted/50')}>
                                  <Icon className={cn('h-4 w-4', isSelected ? 'text-primary' : 'text-muted-foreground')} />
                                </div>
                                <div className="flex-1 min-w-0">
                                  <p className={cn('text-sm font-medium', isSelected && 'text-primary')}>{svc.label}</p>
                                  <p className="text-xs text-muted-foreground">{svc.description}</p>
                                </div>
                                {isSelected && <Check className="h-4 w-4 text-primary flex-shrink-0" />}
                              </motion.button>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <EmptyState
                      icon={Package}
                      title="Nenhum processo registrado"
                      description="Adicione um processo de marca para este cliente"
                      action={
                        <Dialog open={showAddProcessDialog} onOpenChange={setShowAddProcessDialog}>
                          <DialogTrigger asChild>
                            <Button size="sm" className="mt-2"><Plus className="h-4 w-4 mr-2" />Adicionar Processo</Button>
                          </DialogTrigger>
                          <DialogContent>
                            <DialogHeader><DialogTitle>Adicionar Processo de Marca</DialogTitle></DialogHeader>
                            <div className="space-y-4 py-4">
                              <div><Label>Nome da Marca *</Label><Input placeholder="Ex: WebMarcas" value={newProcess.brand_name} onChange={(e) => setNewProcess({...newProcess, brand_name: e.target.value})} /></div>
                              <div><Label>Número do Processo (INPI)</Label><Input placeholder="Ex: 928374651" value={newProcess.process_number} onChange={(e) => setNewProcess({...newProcess, process_number: e.target.value})} /></div>
                              <div><Label>Fase do Pipeline</Label>
                                <Select value={newProcess.pipeline_stage} onValueChange={(v) => setNewProcess({...newProcess, pipeline_stage: v})}>
                                  <SelectTrigger><SelectValue /></SelectTrigger>
                                  <SelectContent>{PIPELINE_STAGES.map(s => <SelectItem key={s.id} value={s.id}>{s.label}</SelectItem>)}</SelectContent>
                                </Select>
                              </div>
                              <div><Label>Área de Atuação</Label><Input placeholder="Ex: Tecnologia" value={newProcess.business_area} onChange={(e) => setNewProcess({...newProcess, business_area: e.target.value})} /></div>
                            </div>
                            <DialogFooter>
                              <Button variant="outline" onClick={() => setShowAddProcessDialog(false)}>Cancelar</Button>
                              <Button onClick={handleCreateProcess}>Criar Processo</Button>
                            </DialogFooter>
                          </DialogContent>
                        </Dialog>
                      }
                    />
                  )}
                </TabsContent>

                {/* ─── APPOINTMENTS TAB ──────────────────────────────────── */}
                <TabsContent value="appointments" className="mt-0 space-y-4">
                  {/* New appointment form */}
                  <AnimatePresence>
                    {showNewAppointment ? (
                      <motion.div
                        initial={{ opacity: 0, height: 0 }}
                        animate={{ opacity: 1, height: 'auto' }}
                        exit={{ opacity: 0, height: 0 }}
                        className="rounded-2xl border border-primary/30 bg-primary/5 p-4 space-y-3 overflow-hidden"
                      >
                        <div className="flex items-center justify-between">
                          <span className="text-sm font-semibold">Novo Agendamento</span>
                          <button className="w-6 h-6 rounded-md hover:bg-muted flex items-center justify-center" onClick={() => setShowNewAppointment(false)}>
                            <X className="h-3.5 w-3.5" />
                          </button>
                        </div>
                        <Input placeholder="Título do agendamento *" value={newAppointment.title} onChange={(e) => setNewAppointment({ ...newAppointment, title: e.target.value })} autoFocus />
                        <Textarea placeholder="Descrição (opcional)" rows={2} value={newAppointment.description} onChange={(e) => setNewAppointment({ ...newAppointment, description: e.target.value })} className="resize-none" />
                        <div className="grid grid-cols-2 gap-3">
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button variant="outline" className="w-full justify-start h-9 text-xs">
                                <CalendarIcon className="h-3.5 w-3.5 mr-2" />
                                {format(newAppointment.date, 'dd/MM/yyyy')}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0">
                              <Calendar mode="single" selected={newAppointment.date} onSelect={(d) => d && setNewAppointment({ ...newAppointment, date: d })} initialFocus />
                            </PopoverContent>
                          </Popover>
                          <Input type="time" value={newAppointment.time} onChange={(e) => setNewAppointment({ ...newAppointment, time: e.target.value })} className="h-9 text-xs" />
                        </div>
                        <Button size="sm" className="w-full h-8" onClick={handleCreateAppointment} disabled={savingAppointment || !newAppointment.title.trim()}>
                          {savingAppointment ? <Loader2 className="h-3 w-3 mr-2 animate-spin" /> : <Plus className="h-3 w-3 mr-2" />}
                          Criar Agendamento
                        </Button>
                      </motion.div>
                    ) : (
                      <Button variant="outline" className="w-full h-10 border-dashed" onClick={() => setShowNewAppointment(true)}>
                        <Plus className="h-4 w-4 mr-2" />Novo Agendamento
                      </Button>
                    )}
                  </AnimatePresence>

                  {loading ? (
                    <div className="flex justify-center py-10"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>
                  ) : appointments.length === 0 ? (
                    <EmptyState icon={CalendarIcon} title="Nenhum agendamento" description="Crie agendamentos e compromissos para este cliente" />
                  ) : (
                    <div className="space-y-2">
                      <AnimatePresence>
                        {appointments.map((apt, i) => {
                          const isPast = new Date(apt.scheduled_at) < new Date();
                          const isOverdue = isPast && !apt.completed;
                          return (
                            <motion.div
                              key={apt.id}
                              initial={{ opacity: 0, x: -10 }}
                              animate={{ opacity: 1, x: 0 }}
                              exit={{ opacity: 0, x: -20 }}
                              transition={{ delay: i * 0.04 }}
                              className={cn(
                                'flex items-center gap-3 p-3 rounded-xl border group transition-all',
                                apt.completed ? 'border-emerald-500/20 bg-emerald-500/5 opacity-70' :
                                isOverdue ? 'border-red-500/20 bg-red-500/5' : 'border-border bg-card hover:bg-muted/20'
                              )}
                            >
                              <button
                                className={cn('w-7 h-7 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all',
                                  apt.completed ? 'bg-emerald-500 border-emerald-500' : 'border-muted-foreground/40 hover:border-primary')}
                                onClick={() => handleToggleAppointment(apt)}
                              >
                                {apt.completed && <Check className="h-3.5 w-3.5 text-white" />}
                              </button>
                              <div className="flex-1 min-w-0">
                                <p className={cn('text-sm font-medium truncate', apt.completed && 'line-through text-muted-foreground')}>{apt.title}</p>
                                {apt.description && <p className="text-xs text-muted-foreground truncate">{apt.description}</p>}
                              </div>
                              <div className="text-right flex-shrink-0">
                                <p className={cn('text-xs font-semibold', isOverdue && 'text-red-400')}>
                                  {format(new Date(apt.scheduled_at), 'dd/MM/yyyy')}
                                </p>
                                <p className="text-[10px] text-muted-foreground">{format(new Date(apt.scheduled_at), 'HH:mm')}</p>
                              </div>
                              <button
                                className="w-6 h-6 rounded-md opacity-0 group-hover:opacity-100 hover:bg-destructive/10 flex items-center justify-center transition-all"
                                onClick={() => handleDeleteAppointment(apt.id)}
                              >
                                <Trash2 className="h-3 w-3 text-muted-foreground" />
                              </button>
                            </motion.div>
                          );
                        })}
                      </AnimatePresence>
                    </div>
                  )}
                </TabsContent>

                {/* ─── ATTACHMENTS TAB ───────────────────────────────────── */}
                <TabsContent value="attachments" className="mt-0 space-y-4">
                  <input ref={fileInputRef} type="file" multiple className="hidden" onChange={(e) => handleFileUpload(e.target.files)} />

                  {/* Drop zone */}
                  <div
                    className={cn(
                      'border-2 border-dashed rounded-2xl p-8 text-center transition-all cursor-pointer',
                      dragOver ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50 hover:bg-muted/20'
                    )}
                    onClick={() => fileInputRef.current?.click()}
                    onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                    onDragLeave={() => setDragOver(false)}
                    onDrop={(e) => { e.preventDefault(); setDragOver(false); handleFileUpload(e.dataTransfer.files); }}
                  >
                    {uploading ? (
                      <div className="flex flex-col items-center gap-2">
                        <Loader2 className="h-8 w-8 text-primary animate-spin" />
                        <p className="text-sm text-muted-foreground">Enviando...</p>
                      </div>
                    ) : (
                      <div className="flex flex-col items-center gap-2">
                        <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                          <Upload className="h-6 w-6 text-primary" />
                        </div>
                        <p className="font-medium text-sm">Arraste arquivos ou clique para selecionar</p>
                        <p className="text-xs text-muted-foreground">PDF, imagens, docs — qualquer formato</p>
                      </div>
                    )}
                  </div>

                  {loading ? (
                    <div className="flex justify-center py-8"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>
                  ) : documents.length === 0 ? (
                    <EmptyState icon={Paperclip} title="Nenhum arquivo" description="Faça upload de documentos relacionados a este cliente" />
                  ) : (
                    <div className="space-y-2">
                      <AnimatePresence>
                        {documents.map(doc => (
                          <motion.div
                            key={doc.id}
                            initial={{ opacity: 0, y: -6 }}
                            animate={{ opacity: 1, y: 0 }}
                            exit={{ opacity: 0, x: -20 }}
                            className="flex items-center gap-3 p-3 rounded-xl border border-border bg-card hover:bg-muted/20 transition-colors group"
                          >
                            <div className="w-9 h-9 rounded-lg bg-muted flex items-center justify-center flex-shrink-0">
                              <DocIcon mime={doc.mime_type} />
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="text-sm font-medium truncate">{doc.name}</p>
                              <p className="text-[10px] text-muted-foreground">
                                {fmtBytes(doc.file_size)}{doc.file_size ? ' · ' : ''}{format(new Date(doc.created_at), 'dd/MM/yyyy HH:mm', { locale: ptBR })}
                              </p>
                            </div>
                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                              <Button variant="ghost" size="icon" className="h-7 w-7" asChild>
                                <a href={doc.file_url} target="_blank" rel="noopener noreferrer" download><ExternalLink className="h-3.5 w-3.5" /></a>
                              </Button>
                              <Button variant="ghost" size="icon" className="h-7 w-7 hover:text-destructive" onClick={() => handleDeleteDocument(doc)}>
                                <Trash2 className="h-3.5 w-3.5" />
                              </Button>
                            </div>
                          </motion.div>
                        ))}
                      </AnimatePresence>
                    </div>
                  )}
                </TabsContent>

                {/* ─── FINANCIAL TAB ─────────────────────────────────────── */}
                <TabsContent value="financial" className="mt-0 space-y-4">
                  {/* Summary card */}
                  <div className="rounded-2xl border border-primary/20 bg-primary/5 p-4">
                    <div className="flex items-center gap-2 mb-3">
                      <BarChart3 className="h-4 w-4 text-primary" />
                      <span className="text-sm font-semibold">Resumo Financeiro</span>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                      {[
                        { label: 'Total', value: invoices.reduce((a, i) => a + Number(i.amount), 0), color: 'text-foreground' },
                        { label: 'Pago', value: invoices.filter(i => i.status === 'paid').reduce((a, i) => a + Number(i.amount), 0), color: 'text-emerald-500' },
                        { label: 'Pendente', value: invoices.filter(i => i.status !== 'paid').reduce((a, i) => a + Number(i.amount), 0), color: 'text-amber-500' },
                      ].map(item => (
                        <div key={item.label} className="text-center">
                          <p className="text-[10px] text-muted-foreground uppercase tracking-wider mb-1">{item.label}</p>
                          <p className={cn('font-bold text-sm', item.color)}>
                            {item.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>

                  {loading ? (
                    <div className="flex justify-center py-8"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>
                  ) : invoices.length === 0 ? (
                    <EmptyState icon={CreditCard} title="Nenhuma fatura" description="As faturas deste cliente aparecerão aqui" />
                  ) : (
                    <div className="space-y-2">
                      <AnimatePresence>
                        {invoices.map((inv, i) => {
                          const STATUS = {
                            paid: { label: 'Paga', cls: 'bg-emerald-500/15 text-emerald-400 border-emerald-500/30' },
                            pending: { label: 'Pendente', cls: 'bg-amber-500/15 text-amber-400 border-amber-500/30' },
                            overdue: { label: 'Vencida', cls: 'bg-red-500/15 text-red-400 border-red-500/30' },
                          }[inv.status] || { label: inv.status, cls: 'bg-muted text-muted-foreground' };
                          return (
                            <motion.div
                              key={inv.id}
                              initial={{ opacity: 0, y: -6 }}
                              animate={{ opacity: 1, y: 0 }}
                              transition={{ delay: i * 0.04 }}
                              className="flex items-center gap-3 p-3 rounded-xl border border-border bg-card"
                            >
                              <div className="w-8 h-8 rounded-lg bg-muted flex items-center justify-center flex-shrink-0">
                                <Receipt className="h-4 w-4 text-muted-foreground" />
                              </div>
                              <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium truncate">{inv.description}</p>
                                <p className="text-[10px] text-muted-foreground">
                                  Vence: {format(new Date(inv.due_date), 'dd/MM/yyyy', { locale: ptBR })}
                                </p>
                              </div>
                              <div className="text-right flex-shrink-0">
                                <p className="font-bold text-sm">{Number(inv.amount).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                <Badge className={cn('border text-[10px] h-4 px-1.5', STATUS.cls)}>{STATUS.label}</Badge>
                              </div>
                            </motion.div>
                          );
                        })}
                      </AnimatePresence>
                    </div>
                  )}
                </TabsContent>

              </div>
            </ScrollArea>
          </Tabs>
        </div>

        {/* ──────────────────────────── FOOTER ────────────────────────────── */}
        <div className="flex-shrink-0 border-t border-border bg-background/95 backdrop-blur px-5 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3 text-xs text-muted-foreground">
            <span className="flex items-center gap-1.5">
              <div className="w-2 h-2 rounded-full bg-emerald-400" />
              Ativo
            </span>
            <span className="font-semibold text-foreground">
              {contractValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
            </span>
            <span className="flex items-center gap-1">
              <Clock className="h-3 w-3" />
              {notes.length > 0 ? formatDistanceToNow(new Date(notes[0].created_at), { addSuffix: true, locale: ptBR }) : 'Nunca'}
            </span>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" size="sm" onClick={() => onOpenChange(false)}>Cancelar</Button>
            <Button size="sm" onClick={() => setShowEditDialog(true)}>
              <Edit2 className="h-3.5 w-3.5 mr-1.5" />Editar
            </Button>
          </div>
        </div>

        {/* ─── Pricing Dialog ──────────────────────────────────────────────── */}
        <Dialog open={showPricingDialog} onOpenChange={setShowPricingDialog}>
          <DialogContent className="sm:max-w-lg">
            <DialogHeader><DialogTitle className="flex items-center gap-2"><Receipt className="h-5 w-5 text-emerald-600" />Selecionar Valor</DialogTitle></DialogHeader>
            <ScrollArea className="max-h-[60vh]">
              <div className="py-4 space-y-2 pr-3">
                <RadioGroup value={selectedPricing} onValueChange={(v) => { setSelectedPricing(v); const opt = SERVICE_PRICING_OPTIONS.find(o => o.id === v); if (opt && v !== 'personalizado') setEditData(prev => ({ ...prev, contract_value: opt.value })); }}>
                  {SERVICE_PRICING_OPTIONS.map(option => (
                    <div key={option.id} className={cn('flex items-start gap-3 p-3 rounded-xl border cursor-pointer transition-all', selectedPricing === option.id ? 'border-emerald-500/40 bg-emerald-500/5' : 'border-border hover:border-emerald-300/40')}
                      onClick={() => { setSelectedPricing(option.id); const opt = SERVICE_PRICING_OPTIONS.find(o => o.id === option.id); if (opt && option.id !== 'personalizado') setEditData(prev => ({ ...prev, contract_value: opt.value })); }}>
                      <RadioGroupItem value={option.id} id={option.id} className="mt-1" />
                      <div className="flex-1">
                        <label htmlFor={option.id} className="font-medium text-sm cursor-pointer">{option.label}</label>
                        <p className="text-xs text-muted-foreground">{option.description}</p>
                        {option.id !== 'personalizado' && <p className="text-sm font-bold text-emerald-600 mt-0.5">R$ {option.value.toLocaleString('pt-BR')}</p>}
                      </div>
                    </div>
                  ))}
                </RadioGroup>
                <AnimatePresence>
                  {selectedPricing === 'personalizado' && (
                    <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} exit={{ opacity: 0, height: 0 }} className="space-y-3 pt-2 overflow-hidden">
                      <div><Label>Valor (R$)</Label><Input type="number" placeholder="0,00" value={customValue || ''} onChange={(e) => { const v = Number(e.target.value); setCustomValue(v); setEditData(prev => ({ ...prev, contract_value: v })); }} className="mt-1" /></div>
                      <div><Label>Motivo</Label><Textarea placeholder="Motivo do valor personalizado..." value={customValueReason} onChange={(e) => setCustomValueReason(e.target.value)} rows={2} className="mt-1 resize-none" /></div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </ScrollArea>
            <DialogFooter>
              <Button variant="outline" onClick={() => setShowPricingDialog(false)}>Cancelar</Button>
              <Button onClick={() => { setShowPricingDialog(false); handleSaveQuickChanges(); toast.success(`Valor: ${editData.contract_value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`); }} className="bg-emerald-600 hover:bg-emerald-700">
                <Check className="h-4 w-4 mr-2" />Confirmar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* ─── Edit Dialog ─────────────────────────────────────────────────── */}
        <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>
          <DialogContent className="sm:max-w-2xl max-h-[90vh]">
            <DialogHeader><DialogTitle className="flex items-center gap-2"><Edit2 className="h-5 w-5" />Editar Cliente</DialogTitle></DialogHeader>
            <ScrollArea className="max-h-[65vh] pr-2">
              <div className="grid grid-cols-2 gap-4 py-4">
                <div className="col-span-2"><Label>Nome Completo</Label><Input value={editFormData.full_name} onChange={(e) => setEditFormData({...editFormData, full_name: e.target.value})} placeholder="Nome completo" /></div>
                <div><Label>E-mail</Label><Input type="email" value={editFormData.email} onChange={(e) => setEditFormData({...editFormData, email: e.target.value})} placeholder="email@exemplo.com" /></div>
                <div><Label>Telefone</Label><Input value={editFormData.phone} onChange={(e) => setEditFormData({...editFormData, phone: e.target.value})} placeholder="(11) 99999-9999" /></div>
                <div><Label>CPF</Label><Input value={editFormData.cpf} onChange={(e) => setEditFormData({...editFormData, cpf: e.target.value})} placeholder="000.000.000-00" /></div>
                <div><Label>CNPJ</Label><Input value={editFormData.cnpj} onChange={(e) => setEditFormData({...editFormData, cnpj: e.target.value})} placeholder="00.000.000/0001-00" /></div>
                <div><Label>Empresa</Label><Input value={editFormData.company_name} onChange={(e) => setEditFormData({...editFormData, company_name: e.target.value})} placeholder="Nome da empresa" /></div>
                <div className="col-span-2"><Label>Endereço</Label><Input value={editFormData.address} onChange={(e) => setEditFormData({...editFormData, address: e.target.value})} placeholder="Rua, número" /></div>
                <div><Label>Bairro</Label><Input value={editFormData.neighborhood} onChange={(e) => setEditFormData({...editFormData, neighborhood: e.target.value})} placeholder="Bairro" /></div>
                <div><Label>Cidade</Label><Input value={editFormData.city} onChange={(e) => setEditFormData({...editFormData, city: e.target.value})} placeholder="Cidade" /></div>
                <div><Label>Estado</Label>
                  <Select value={editFormData.state} onValueChange={(v) => setEditFormData({...editFormData, state: v})}>
                    <SelectTrigger><SelectValue placeholder="Selecione" /></SelectTrigger>
                    <SelectContent>{['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'].map(uf => <SelectItem key={uf} value={uf}>{uf}</SelectItem>)}</SelectContent>
                  </Select>
                </div>
                <div><Label>CEP</Label><Input value={editFormData.zip_code} onChange={(e) => setEditFormData({...editFormData, zip_code: e.target.value})} placeholder="00000-000" /></div>
                {client?.process_id && (
                  <>
                    <div><Label>Nome da Marca</Label><Input value={editFormData.brand_name} onChange={(e) => setEditFormData({...editFormData, brand_name: e.target.value})} placeholder="Nome da marca" /></div>
                    <div><Label>Ramo de Atividade</Label><Input value={editFormData.business_area} onChange={(e) => setEditFormData({...editFormData, business_area: e.target.value})} placeholder="Ex: Tecnologia" /></div>
                  </>
                )}
                <div><Label>Prioridade</Label>
                  <Select value={editFormData.priority} onValueChange={(v) => setEditFormData({...editFormData, priority: v})}>
                    <SelectTrigger><SelectValue /></SelectTrigger>
                    <SelectContent><SelectItem value="low">Baixa</SelectItem><SelectItem value="medium">Média</SelectItem><SelectItem value="high">Alta</SelectItem></SelectContent>
                  </Select>
                </div>
                <div><Label>Origem</Label>
                  <Select value={editFormData.origin} onValueChange={(v) => setEditFormData({...editFormData, origin: v})}>
                    <SelectTrigger><SelectValue /></SelectTrigger>
                    <SelectContent><SelectItem value="site">Site</SelectItem><SelectItem value="whatsapp">WhatsApp</SelectItem><SelectItem value="indicacao">Indicação</SelectItem><SelectItem value="instagram">Instagram</SelectItem></SelectContent>
                  </Select>
                </div>
                <div className="col-span-2"><Label className="flex items-center gap-1"><UserCheck className="h-3.5 w-3.5" />Atribuir a</Label>
                  <Select value={editFormData.assigned_to} onValueChange={(v) => setEditFormData({...editFormData, assigned_to: v === 'none' ? '' : v})}>
                    <SelectTrigger><SelectValue placeholder="Não atribuído" /></SelectTrigger>
                    <SelectContent className="max-h-60"><SelectItem value="none">Nenhum</SelectItem>{adminUsersList.map(a => <SelectItem key={a.id} value={a.id}>{a.full_name || a.email}</SelectItem>)}</SelectContent>
                  </Select>
                </div>
              </div>
            </ScrollArea>
            <DialogFooter>
              <Button variant="outline" onClick={() => setShowEditDialog(false)}>Cancelar</Button>
              <Button onClick={handleSaveFullEdit} disabled={savingEdit}>
                {savingEdit ? <Loader2 className="h-4 w-4 mr-2 animate-spin" /> : <Check className="h-4 w-4 mr-2" />}
                Salvar Alterações
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* ─── Move Dialog ──────────────────────────────────────────────────── */}
        <Dialog open={showMoveDialog} onOpenChange={setShowMoveDialog}>
          <DialogContent className="sm:max-w-md">
            <DialogHeader><DialogTitle className="flex items-center gap-2"><ArrowUpRight className="h-5 w-5 text-blue-600" />Mover para Funil</DialogTitle></DialogHeader>
            <div className="py-4 space-y-3">
              <p className="text-sm text-muted-foreground">Funil atual: <strong>{(client?.client_funnel_type || 'juridico') === 'comercial' ? 'Comercial' : 'Jurídico'}</strong></p>
              <div className="grid grid-cols-2 gap-3">
                {[
                  { id: 'comercial', label: 'Comercial', desc: 'Pipeline de vendas', Icon: Building2, color: 'blue' },
                  { id: 'juridico', label: 'Jurídico', desc: 'Processos INPI', Icon: Lock, color: 'purple' },
                ].map(({ id, label, desc, Icon, color }) => {
                  const isCurrent = (client?.client_funnel_type || 'juridico') === id;
                  return (
                    <button key={id} className={cn('p-4 rounded-xl border-2 text-center transition-all', isCurrent ? `border-${color}-500 bg-${color}-50 dark:bg-${color}-950/30 opacity-50 cursor-not-allowed` : `border-border hover:border-${color}-500 hover:bg-${color}-50 dark:hover:bg-${color}-950/20`)} disabled={isCurrent} onClick={() => handleMoveFunnel(id as any)}>
                      <Icon className={`h-8 w-8 mx-auto mb-2 text-${color}-600`} />
                      <p className="font-semibold text-sm">{label}</p>
                      <p className="text-xs text-muted-foreground mt-0.5">{desc}</p>
                    </button>
                  );
                })}
              </div>
            </div>
            <DialogFooter><Button variant="outline" onClick={() => setShowMoveDialog(false)}>Cancelar</Button></DialogFooter>
          </DialogContent>
        </Dialog>

        {/* ─── Notification Dialog ──────────────────────────────────────────── */}
        <Dialog open={showNotificationDialog} onOpenChange={setShowNotificationDialog}>
          <DialogContent className="sm:max-w-md">
            <DialogHeader><DialogTitle className="flex items-center gap-2"><Bell className="h-5 w-5" />Enviar Notificação</DialogTitle></DialogHeader>
            <div className="space-y-4 py-4">
              {notificationTemplates.length > 0 && (
                <div>
                  <Label>Template</Label>
                  <Select onValueChange={(v) => { const tpl = notificationTemplates.find(t => t.id === v); if (tpl) setNotificationForm(prev => ({ ...prev, title: tpl.title, message: tpl.message, type: tpl.type })); }}>
                    <SelectTrigger><SelectValue placeholder="Selecionar template…" /></SelectTrigger>
                    <SelectContent>{notificationTemplates.map(t => <SelectItem key={t.id} value={t.id}>{t.name}</SelectItem>)}</SelectContent>
                  </Select>
                </div>
              )}
              <div><Label>Título *</Label><Input value={notificationForm.title} onChange={(e) => setNotificationForm(prev => ({ ...prev, title: e.target.value }))} placeholder="Título da notificação" /></div>
              <div><Label>Mensagem *</Label><Textarea value={notificationForm.message} onChange={(e) => setNotificationForm(prev => ({ ...prev, message: e.target.value }))} rows={3} className="resize-none" placeholder="Conteúdo da notificação…" /></div>
              <div><Label>Link (opcional)</Label><Input value={notificationForm.link} onChange={(e) => setNotificationForm(prev => ({ ...prev, link: e.target.value }))} placeholder="/cliente/processos" /></div>
            </div>
            <DialogFooter>
              <Button variant="outline" onClick={() => setShowNotificationDialog(false)}>Cancelar</Button>
              <Button onClick={async () => {
                if (!notificationForm.title || !notificationForm.message || !client) return;
                try {
                  await supabase.from('notifications').insert({ user_id: client.id, title: notificationForm.title, message: notificationForm.message, type: notificationForm.type, link: notificationForm.link || null, read: false });
                  toast.success('Notificação enviada!');
                  setShowNotificationDialog(false);
                } catch { toast.error('Erro ao enviar notificação'); }
              }} disabled={!notificationForm.title || !notificationForm.message}>
                <Send className="h-4 w-4 mr-2" />Enviar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </SheetContent>
    </Sheet>
  );
}
